<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyx Studio - æäº¤è®¢å•</title>
    <meta name="description" content="Nyx Studio æäº¤è®¢å•">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <!-- èƒŒæ™¯è£…é¥° -->
    <div class="bg-decoration"></div>
    <div class="stars-container"></div>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content">
        <div class="container" id="pageContent">
            <!-- å†…å®¹å°†é€šè¿‡JSåŠ è½½ -->
        </div>
    </div>

    <!-- æˆåŠŸå¼¹çª— -->
    <div id="successModal" class="modal-overlay hidden">
        <div class="card modal-content text-center" style="padding: 40px;">
            <div style="font-size: 64px; margin-bottom: 16px;">âœ¨</div>
            <h2 style="color: var(--success); margin-bottom: 8px;">æäº¤æˆåŠŸï¼</h2>
            <p class="text-muted">è®¢å•å·²æäº¤ï¼Œç­‰å¾…å®¡æ ¸ä¸­ï½</p>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script src="utils.js"></script>
    <script>
        let cachedOrders = [];

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        const user = requireReceptionist();
        if (!user) {
            // ä¼šè‡ªåŠ¨è·³è½¬
        } else {
            initPage();
        }

        async function initPage() {
            // é¢„åŠ è½½è®¢å•æ•°æ®ç”¨äºéªŒè¯
            cachedOrders = await DataStore.getOrders();
            renderPage();
        }

        function renderPage() {
            const html = `
        <div class="back-header">
          <button class="back-button" onclick="navigateTo('receptionist.html')">â†</button>
          <h1 class="page-title">ğŸ“ æäº¤è®¢å•</h1>
        </div>
        
        <div class="card">
          <form id="orderForm">
            <div class="form-group">
              <label class="form-label">æ—¥æœŸ</label>
              <input type="date" id="orderDate" class="form-input" value="${getToday()}" required>
              <p class="form-hint">è¯·ç¡®å®šå¥½æ—¥æœŸæ˜¯å¦æ­£ç¡®å“¦å®å®ï½</p>
            </div>
            
            <div class="form-group">
              <label class="form-label">æ¥å¾…åç§°</label>
              <input type="text" class="form-input form-input-readonly" value="${user.emoji} ${user.name}" disabled>
            </div>
            
            <div class="form-group">
              <label class="form-label">è€æ¿åç§°</label>
              <input type="text" id="bossName" class="form-input" placeholder="è¯·è¾“å…¥è€æ¿åç§°" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">å•å­ç±»å‹</label>
              <select id="orderType" class="form-select" onchange="onOrderTypeChange()">
                <option value="normal">æ­£å¸¸å•</option>
                <option value="gift">ç¤¼ç‰©å•</option>
                <option value="monthly">æœˆå¡å•</option>
                <option value="prepaid">é¢„å­˜å•</option>
                <option value="deduct_prepaid">æ‰£é™¤å­˜å•</option>
              </select>
            </div>
            
            <div class="form-group" id="divinerGroup">
              <label class="form-label">å åœå¸ˆåç§°</label>
              <input type="text" id="divinerId" class="form-input" placeholder="è¯·è¾“å…¥å åœå¸ˆåç§°">
            </div>
            
            <div class="form-group" id="questionGroup">
              <label class="form-label">é—®é¢˜å†…å®¹</label>
              <input type="text" id="questionContent" class="form-input" placeholder="è¯·ç®€å•æè¿°å åœå†…å®¹">
            </div>
            
            <div class="form-group" id="amountGroup">
              <label class="form-label">é‡‘é¢</label>
              <input type="number" id="amount" class="form-input" placeholder="è¯·è¾“å…¥é‡‘é¢" step="0.01">
              <p class="form-hint" id="amountHint">å…è®¸é‡‘é¢ï¼š${allowedNormalAmounts.slice().sort((a, b) => a - b).join('ã€')}</p>
            </div>
            
            <div class="form-group hidden" id="discountGroup">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <input type="checkbox" id="hasDiscount" style="width: 18px; height: 18px; accent-color: var(--accent);" onchange="onDiscountToggle()">
                <label for="hasDiscount" style="cursor: pointer; font-size: 14px;">æœ‰æŠ˜æ‰£</label>
              </div>
              <div id="discountInputWrapper" class="hidden" style="display: flex; align-items: center; gap: 8px;">
                <input type="number" id="discountValue" class="form-input" placeholder="å¦‚ï¼š9ã€8.5ã€8" step="0.1" min="1" max="9.9" style="width: 100px;">
                <span style="font-size: 14px; color: var(--text-muted);">æŠ˜</span>
                <span id="discountPreview" style="font-size: 12px; color: var(--accent); margin-left: 10px;"></span>
              </div>
            </div>
            
            <div class="form-group hidden" id="monthlyAmountGroup">
              <label class="form-label">é‡‘é¢</label>
              <div class="form-input form-input-readonly">æ— </div>
            </div>
            
            <div id="errorMessage" class="error-message hidden"></div>
            
            <button type="submit" id="submitBtn" class="btn btn-accent btn-full">ç¡®è®¤æäº¤</button>
          </form>
        </div>
      `;

            document.getElementById('pageContent').innerHTML = html;
            onOrderTypeChange();
        }

        function onOrderTypeChange() {
            const orderType = document.getElementById('orderType').value;
            const isMonthly = orderType === 'monthly';
            const isPrepaid = orderType === 'prepaid';
            const isDeductPrepaid = orderType === 'deduct_prepaid';
            const isNormal = orderType === 'normal';

            // å åœå¸ˆåç§° 
            const divinerGroup = document.getElementById('divinerGroup');
            const divinerId = document.getElementById('divinerId');
            if (isMonthly || isPrepaid) {
                divinerGroup.style.display = 'none';
                divinerId.value = 'æ— ';
            } else {
                divinerGroup.style.display = 'block';
                if (divinerId.value === 'æ— ') divinerId.value = '';
            }

            // é—®é¢˜å†…å®¹
            const questionGroup = document.getElementById('questionGroup');
            if (isMonthly || isPrepaid) {
                questionGroup.style.display = 'none';
            } else {
                questionGroup.style.display = 'block';
            }

            // é‡‘é¢
            const amountGroup = document.getElementById('amountGroup');
            const monthlyAmountGroup = document.getElementById('monthlyAmountGroup');
            const amountHint = document.getElementById('amountHint');

            if (isMonthly) {
                amountGroup.style.display = 'none';
                monthlyAmountGroup.style.display = 'block';
            } else {
                amountGroup.style.display = 'block';
                monthlyAmountGroup.style.display = 'none';

                if (isNormal) {
                    amountHint.innerHTML = `å…è®¸é‡‘é¢ï¼š${allowedNormalAmounts.slice().sort((a, b) => a - b).join('ã€')}`;
                    amountHint.style.display = 'block';
                } else if (isDeductPrepaid) {
                    amountHint.innerHTML = `å…è®¸é‡‘é¢ï¼š${allowedDeductAmounts.slice().sort((a, b) => a - b).join('ã€')}`;
                    amountHint.style.display = 'block';
                } else {
                    amountHint.style.display = 'none';
                }
            }

            // æŠ˜æ‰£é€‰é¡¹åªåœ¨æ­£å¸¸å•æ—¶æ˜¾ç¤º
            const discountGroup = document.getElementById('discountGroup');
            if (isNormal) {
                discountGroup.classList.remove('hidden');
            } else {
                discountGroup.classList.add('hidden');
                document.getElementById('hasDiscount').checked = false;
                document.getElementById('discountInputWrapper').classList.add('hidden');
            }
        }

        // æŠ˜æ‰£å¼€å…³åˆ‡æ¢
        function onDiscountToggle() {
            const hasDiscount = document.getElementById('hasDiscount').checked;
            const wrapper = document.getElementById('discountInputWrapper');
            if (hasDiscount) {
                wrapper.classList.remove('hidden');
                wrapper.style.display = 'flex';
            } else {
                wrapper.classList.add('hidden');
                wrapper.style.display = 'none';
                document.getElementById('discountValue').value = '';
                document.getElementById('discountPreview').textContent = '';
            }
        }

        // é‡‘é¢è¾“å…¥æ—¶æ›´æ–°æŠ˜æ‰£é¢„è§ˆ
        document.getElementById('pageContent').addEventListener('input', function (e) {
            if (e.target.id === 'amount' || e.target.id === 'discountValue') {
                updateDiscountPreview();
            }
        });

        function updateDiscountPreview() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
            const preview = document.getElementById('discountPreview');

            if (amount > 0 && discountValue > 0 && discountValue < 10) {
                const discountedAmount = (amount * discountValue / 10).toFixed(2);
                preview.textContent = `æŠ˜å: Â¥${discountedAmount}`;
            } else {
                preview.textContent = '';
            }
        }

        // åŒæ­¥è®¡ç®—è€æ¿ä½™é¢
        function getBossBalanceFromCache(bossName) {
            const bossOrders = cachedOrders.filter(o => o.bossName === bossName && o.approved !== false);
            const totalPrepaid = bossOrders.filter(o => o.type === 'prepaid').reduce((sum, o) => sum + (o.amount || 0), 0);
            const totalDeducted = bossOrders.filter(o => o.type === 'deduct_prepaid').reduce((sum, o) => sum + (o.amount || 0), 0);
            return totalPrepaid - totalDeducted;
        }

        // æ£€æŸ¥è€æ¿æ˜¯å¦åœ¨ç³»ç»Ÿä¸­
        function isBossInSystemSync(bossName) {
            return cachedOrders.some(o => o.type === 'prepaid' && o.bossName === bossName);
        }

        document.getElementById('pageContent').addEventListener('submit', async function (e) {
            if (e.target.id === 'orderForm') {
                e.preventDefault();

                const orderType = document.getElementById('orderType').value;
                const bossName = document.getElementById('bossName').value.trim();
                const amount = document.getElementById('amount').value;
                const errorDiv = document.getElementById('errorMessage');
                const submitBtn = document.getElementById('submitBtn');

                // éªŒè¯
                if (!bossName) {
                    errorDiv.textContent = 'è¡¥è¯èµ°ï¼Œè¿˜æ²¡æœ‰å¡«å†™å®Œæ•´å‘¢(ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡)';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                if (orderType !== 'monthly' && !amount) {
                    errorDiv.textContent = 'è¡¥è¯èµ°ï¼Œè¿˜æ²¡æœ‰å¡«å†™å®Œæ•´å‘¢(ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡)';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                // æ‰£é™¤é¢„å­˜å•ç‰¹æ®ŠéªŒè¯
                if (orderType === 'deduct_prepaid') {
                    if (!isBossInSystemSync(bossName)) {
                        errorDiv.textContent = 'è¯·ç¡®è®¤åå­—';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    const currentBalance = getBossBalanceFromCache(bossName);
                    const deductAmount = parseFloat(amount);
                    if (currentBalance < deductAmount) {
                        errorDiv.textContent = 'ä½™é¢ä¸è¶³äº†( Â´â€¢Ì¥Ì¥Ì¥Ï‰â€¢Ì¥Ì¥Ì¥ )';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    if (!allowedDeductAmounts.includes(deductAmount)) {
                        errorDiv.textContent = 'è¾“å…¥é‡‘é¢æœ‰è¯¯';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    const questionContent = document.getElementById('questionContent').value.trim();
                    if (!questionContent) {
                        errorDiv.textContent = 'æ‰£é™¤å­˜å•å¿…é¡»å¡«å†™é—®é¢˜å†…å®¹å“¦å®å®ï½';
                        errorDiv.classList.remove('hidden');
                        return;
                    }
                    const divinerId = document.getElementById('divinerId').value.trim();
                    if (!divinerId || divinerId === 'æ— ') {
                        errorDiv.textContent = 'æ‰£é™¤å­˜å•å¿…é¡»å¡«å†™å åœå¸ˆå“¦å®å®ï½';
                        errorDiv.classList.remove('hidden');
                        return;
                    }
                }

                // æ­£å¸¸å•éªŒè¯ï¼ˆåªéªŒè¯é—®é¢˜å†…å®¹ï¼Œé‡‘é¢å¯ä»»æ„è¾“å…¥ï¼‰
                if (orderType === 'normal') {
                    const questionContent = document.getElementById('questionContent').value.trim();
                    if (!questionContent) {
                        errorDiv.textContent = 'æ­£å¸¸å•å¿…é¡»å¡«å†™é—®é¢˜å†…å®¹å“¦å®å®ï½';
                        errorDiv.classList.remove('hidden');
                        return;
                    }
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                submitBtn.disabled = true;
                submitBtn.textContent = 'æäº¤ä¸­...';
                errorDiv.classList.add('hidden');

                try {
                    // è·å–æŠ˜æ‰£ä¿¡æ¯
                    const hasDiscount = orderType === 'normal' && document.getElementById('hasDiscount').checked;
                    const discountValue = hasDiscount ? parseFloat(document.getElementById('discountValue').value) : null;
                    const originalAmount = orderType === 'monthly' ? 0 : parseFloat(amount);

                    // è®¡ç®—æŠ˜åé‡‘é¢
                    let finalAmount = originalAmount;
                    if (hasDiscount && discountValue && discountValue > 0 && discountValue < 10) {
                        finalAmount = originalAmount * discountValue / 10;
                    }

                    const orderData = {
                        date: document.getElementById('orderDate').value,
                        bossName: bossName,
                        type: orderType,
                        divinerId: (orderType === 'monthly' || orderType === 'prepaid') ? 'æ— ' : document.getElementById('divinerId').value,
                        amount: finalAmount,  // ä½¿ç”¨æŠ˜åé‡‘é¢
                        originalAmount: hasDiscount ? originalAmount : null,  // åŸä»·ï¼ˆå¦‚æœ‰æŠ˜æ‰£ï¼‰
                        discount: discountValue,  // æŠ˜æ‰£å€¼ï¼ˆå¦‚ 8 è¡¨ç¤º 8æŠ˜ï¼‰
                        questionContent: (orderType === 'monthly' || orderType === 'prepaid') ? '' : document.getElementById('questionContent').value
                    };

                    const result = await submitOrder(orderData);

                    if (result.success) {
                        document.getElementById('successModal').classList.remove('hidden');
                        setTimeout(() => {
                            navigateTo('receptionist.html');
                        }, 1500);
                    } else {
                        errorDiv.textContent = result.message || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•';
                        errorDiv.classList.remove('hidden');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'ç¡®è®¤æäº¤';
                    }
                } catch (e) {
                    console.error('æäº¤è®¢å•å‡ºé”™:', e);
                    errorDiv.textContent = 'æäº¤å‡ºé”™: ' + e.message;
                    errorDiv.classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ç¡®è®¤æäº¤';
                }
            }
        });
    </script>
</body>

</html>