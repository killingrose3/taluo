<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nyx Studio - æ¥å¾…å‘˜ä¸»é¡µ</title>
  <meta name="description" content="Nyx Studio æ¥å¾…å‘˜å·¥ä½œå°">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="bg-decoration"></div>
  <div class="stars-container"></div>

  <div class="main-content">
    <div class="container" id="pageContent">
      <div style="display: flex; justify-content: center; align-items: center; padding: 40px;">
        <div
          style="width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;">
        </div>
      </div>
      <style>
        @keyframes spin {
          to {
            transform: rotate(360deg);
          }
        }
      </style>
    </div>
  </div>

  <div id="announcementModal" class="modal-overlay hidden">
    <div class="card modal-content" style="max-width: 450px; max-height: 80vh; overflow-y: auto;">
      <div style="text-align: center;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¢</div>
        <h2 style="color: var(--accent); margin-bottom: 16px;">é€šçŸ¥å…¬å‘Š</h2>
      </div>
      <div id="announcementContent" style="margin-bottom: 20px;"></div>
      <button class="btn btn-accent btn-full" onclick="closeAnnouncement()">å¥½æ»´ï¼æ”¶åˆ°ï¼</button>
    </div>
  </div>

  <script src="supabase-config.js"></script>
  <script src="utils.js"></script>
  <script>
    let showBalanceDetail = false;
    let showPenalties = false;
    let unreadCount = 0;
    let cachedData = null;

    const user = requireReceptionist();
    if (!user) {
      // ä¼šè‡ªåŠ¨è·³è½¬
    } else {
      initPage();
    }

    async function initPage() {
      await loadData();
      renderPage();
    }

    async function loadData() {
      const [receptionists, orders, penalties, announcements] = await Promise.all([
        DataStore.getReceptionists(),
        DataStore.getOrders(),
        DataStore.getPenaltiesByReceptionist(user.id),
        DataStore.getAnnouncements()
      ]);

      const readAnnouncements = await DataStore.getReadAnnouncements(user.id);
      const currentReceptionist = receptionists.find(r => r.id === user.id) || user;
      const userOrders = orders.filter(o => o.receptionistId === user.id && o.approved !== false);

      cachedData = {
        receptionists,
        orders,
        userOrders,
        penalties,
        announcements,
        readAnnouncements,
        currentReceptionist
      };
    }

    function renderPage() {
      if (!cachedData) return;

      const { userOrders, penalties, announcements, readAnnouncements, currentReceptionist } = cachedData;

      // è®¡ç®—æœªè¯»é€šçŸ¥æ•°é‡
      unreadCount = announcements.filter(a => !readAnnouncements.includes(a.id)).length;

      // ç»“ç®—é€»è¾‘
      const lastSettlementTime = currentReceptionist.lastSettlementDate ? new Date(currentReceptionist.lastSettlementDate).getTime() : 0;
      const weekStart = getWeekStart().getTime();
      const taskStartTime = Math.max(weekStart, lastSettlementTime);

      // å‘¨æœŸå†…è®¢å•
      const weeklyOrders = userOrders.filter(o => {
        const orderTime = new Date(o.createdAt).getTime();
        return orderTime > lastSettlementTime && orderTime >= weekStart;
      });

      const weeklyMonthlyOrders = weeklyOrders.filter(o => o.type === 'monthly').length;
      const taskComplete = weeklyMonthlyOrders >= 3;

      const weeklyFlow = weeklyOrders
        .filter(o => o.type === 'normal' || o.type === 'prepaid')
        .reduce((sum, o) => sum + (o.amount || 0), 0);

      const weeklyPrepaid = weeklyOrders
        .filter(o => o.type === 'prepaid')
        .reduce((sum, o) => sum + (o.amount || 0), 0);

      // è®¡ç®—ä½™é¢
      const balanceData = calculateBalanceSync(userOrders, penalties, currentReceptionist, taskComplete);

      // ä» localStorage è·å– promotionChecks
      const promotionChecks = JSON.parse(localStorage.getItem(`nyx_promo_${user.id}`) || '[false,false,false,false]');

      let buffHtml = '';
      if (currentReceptionist.commissionExpiry && new Date(currentReceptionist.commissionExpiry) > new Date()) {
        const d = new Date(currentReceptionist.commissionExpiry);
        buffHtml = '<p style="color: var(--accent); font-size: 13px; margin-top: 4px;">âœ¨ ææˆbuffå¢åŠ ä¸­ï½' + (d.getMonth() + 1) + 'æœˆ' + d.getDate() + 'æ—¥ç»“æŸ</p>';
      }

      let html = '<div class="page-header">' +
        '<h1 class="page-title">ğŸŒ™ Nyx Studio</h1>' +
        '<button class="btn-text" onclick="logout()">é€€å‡ºç™»å½•</button>' +
        '</div>' +
        '<div class="card mb-5">' +
        '<div class="user-card">' +
        '<div class="user-avatar">' + user.emoji + '</div>' +
        '<div class="user-info">' +
        '<div class="user-name">' + user.name +
        '<button class="notification-bubble" onclick="showAnnouncement()">ğŸ“¢ é€šçŸ¥' + (unreadCount > 0 ? '<span class="notification-dot"></span>' : '') + '</button>' +
        '</div><p class="user-role">èŒä½ï¼šæ¥å¾…' + (currentReceptionist.isIntern ? '<span style="color: var(--warning); background: rgba(245, 158, 11, 0.15); padding: 2px 8px; border-radius: 4px; margin-left: 8px; font-size: 12px;">æ­£åœ¨å®ä¹ æœŸï¼ŒåŠ æ²¹ä¸­ï¼ï¼ï¼</span>' : '') + '</p>' + buffHtml + '</div></div>';

      html += '<div class="balance-card ' + (balanceData.taskFailed ? 'balance-card-failed' : 'balance-card-normal') + '" onclick="toggleBalanceDetail()">' +
        '<div class="balance-label">' +
        '<span>å½“å‰ä½™é¢</span>' +
        '<span class="text-xs">' + (showBalanceDetail ? 'â–² æ”¶èµ·' : 'â–¼ ç‚¹å‡»æŸ¥çœ‹æ˜ç»†') + '</span>' +
        '</div>' +
        '<p class="balance-amount ' + (balanceData.taskFailed ? 'balance-amount-failed' : 'balance-amount-normal') + '">Â¥' + balanceData.amount.toFixed(2) + '</p>';

      if (balanceData.taskFailed) {
        html += '<p style="color: var(--danger); font-size: 14px; margin-top: 12px;">æœªå®Œæˆä»»åŠ¡TvT è”ç³»è¿è¥å¥½ä¹ˆå®å®</p>';
      }

      if (showBalanceDetail && !balanceData.taskFailed) {
        html += renderBalanceDetail(userOrders, penalties, currentReceptionist, balanceData, taskComplete);
      }

      html += '</div></div>';

      // å‘¨ä»»åŠ¡è¿›åº¦
      html += '<div class="card mb-5">';
      if (!taskComplete) {
        html += '<h3 style="font-size: 16px; margin-bottom: 12px;">ğŸ“‹ æœ¬å‘¨ä»»åŠ¡</h3>' +
          '<div class="flex items-center gap-3 mb-2">' +
          '<div class="progress-bar"><div class="progress-fill progress-fill-warning" style="width: ' + Math.min(weeklyMonthlyOrders / 3 * 100, 100) + '%"></div></div>' +
          '<span class="text-sm text-muted">' + weeklyMonthlyOrders + '/3 æœˆå¡å•</span>' +
          '</div>' +
          '<p style="font-size: 13px; color: var(--danger);">âš ï¸ æœªå®Œæˆä»»åŠ¡å°†å¯¼è‡´æœ¬å‘¨ææˆæ¸…é›¶</p>';
      } else {
        html += '<h3 style="font-size: 16px; margin-bottom: 8px; color: var(--success);">ğŸ‰ å‘¨ä»»åŠ¡å·²å®Œæˆ å¤ªæ£’å•¦å®å®!</h3>';

        // ä»»åŠ¡1
        html += '<div class="task-block"><p style="font-size: 14px; margin-bottom: 8px;">1ï¸âƒ£ å‘¨æµæ°´è¾¾åˆ°500</p>' +
          '<div class="flex items-center gap-3"><div class="progress-bar">' +
          '<div class="progress-fill ' + (weeklyFlow >= 500 ? 'progress-fill-success' : 'progress-fill-primary') + '" style="width: ' + Math.min(weeklyFlow / 500 * 100, 100) + '%"></div></div>' +
          '<span class="text-xs ' + (weeklyFlow >= 500 ? 'order-type-monthly' : 'text-muted') + '">' + Math.min(Math.round(weeklyFlow / 500 * 100), 100) + '%</span></div></div>';

        // ä»»åŠ¡2
        html += '<div class="task-block"><p style="font-size: 14px; margin-bottom: 8px;">2ï¸âƒ£ åœ¨ä»»æ„å¹³å°å‘å¸ƒå®£ä¼ è´´æ–‡4æ¡</p><div class="flex gap-2 flex-wrap">';
        for (let i = 0; i < 4; i++) {
          html += '<button class="task-check-btn" style="border: 2px solid ' + (promotionChecks[i] ? 'var(--success)' : 'var(--border)') + '; background: ' + (promotionChecks[i] ? 'rgba(16,185,129,0.2)' : 'transparent') + '; color: ' + (promotionChecks[i] ? 'var(--success)' : 'var(--text-muted)') + ';" onclick="togglePromotionCheck(' + i + ')">' + (promotionChecks[i] ? 'âœ“' : (i + 1)) + '</button>';
        }
        html += '<span class="text-xs ' + (promotionChecks.filter(Boolean).length >= 4 ? 'order-type-monthly' : 'text-muted') + '" style="align-self: center; margin-left: 8px;">' + promotionChecks.filter(Boolean).length + '/4</span></div></div>';

        // ä»»åŠ¡3
        html += '<div class="task-block"><p style="font-size: 14px; margin-bottom: 8px;">3ï¸âƒ£ è€æ¿é¢„å­˜666</p>' +
          '<div class="flex items-center gap-3"><div class="progress-bar">' +
          '<div class="progress-fill ' + (weeklyPrepaid >= 666 ? 'progress-fill-success' : 'progress-fill-warning') + '" style="width: ' + Math.min(weeklyPrepaid / 666 * 100, 100) + '%"></div></div>' +
          '<span class="text-xs ' + (weeklyPrepaid >= 666 ? 'order-type-monthly' : 'text-muted') + '">' + Math.min(Math.round(weeklyPrepaid / 666 * 100), 100) + '%</span></div></div>';

        // ä»»åŠ¡4
        html += '<div class="task-block" style="margin-bottom: 0;"><p style="font-size: 14px; margin-bottom: 8px;">4ï¸âƒ£ æ‹‰åˆ°ä¸‹å•æœˆå¡è€æ¿9å</p>' +
          '<div class="flex items-center gap-3"><div class="progress-bar">' +
          '<div class="progress-fill ' + (weeklyMonthlyOrders >= 9 ? 'progress-fill-success' : 'progress-fill-primary') + '" style="width: ' + Math.min(weeklyMonthlyOrders / 9 * 100, 100) + '%"></div></div>' +
          '<span class="text-xs ' + (weeklyMonthlyOrders >= 9 ? 'order-type-monthly' : 'text-muted') + '">' + weeklyMonthlyOrders + '/9</span></div></div>';
      }
      html += '</div>';

      html += renderPenaltiesSection(penalties);

      html += '<div class="flex flex-col gap-3">' +
        '<button class="btn btn-accent btn-full" onclick="navigateTo(\'submit-order.html\')">ğŸ“ æäº¤è®¢å•</button>' +
        '<button class="btn btn-secondary btn-full" onclick="navigateTo(\'view-records.html\')">ğŸ“… æŸ¥çœ‹æˆ‘çš„æäº¤è®°å½•</button>' +
        '</div>';

      document.getElementById('pageContent').innerHTML = html;
    }

    function calculateBalanceSync(orders, penalties, receptionist, taskComplete) {
      const lastSettlementTime = receptionist.lastSettlementDate ? new Date(receptionist.lastSettlementDate).getTime() : 0;

      const userOrders = orders.filter(o =>
        o.approved !== false &&
        new Date(o.createdAt).getTime() > lastSettlementTime
      );

      let balance = 0;
      userOrders.forEach(order => {
        if (order.type === 'bonus') {
          balance += order.amount;
        } else if (order.type !== 'monthly' && order.type !== 'deduct_prepaid') {
          balance += calculateCommission(order, receptionist);
        }
      });

      // å‡å»æƒ©ç½š
      penalties.forEach(p => {
        const penaltyTime = p.createdAt ? new Date(p.createdAt).getTime() : new Date(p.date).getTime();
        if (penaltyTime > lastSettlementTime) {
          balance -= p.amount;
        }
      });

      if (isAfterSundayDeadline() && !taskComplete) {
        return { amount: 0, taskFailed: true };
      }

      if (taskComplete) {
        const baseSalary = receptionist.isIntern ? 20 : 40;
        balance += baseSalary;
      }

      return { amount: Math.round(balance * 100) / 100, taskFailed: false };
    }

    function renderBalanceDetail(orders, penalties, receptionist, balanceData, taskComplete) {
      let html = '<div class="balance-detail" onclick="event.stopPropagation()">' +
        '<h4 style="font-size: 14px; margin-bottom: 12px; color: var(--text);">ğŸ’° ä½™é¢æ¥æºæ˜ç»†</h4>';

      if (taskComplete) {
        html += '<div class="balance-detail-item"><span class="balance-detail-label">ğŸ¯ åº•è–ªï¼ˆ' + (receptionist.isIntern ? 'å®ä¹ ' : 'æ­£å¼') + 'ï¼‰</span>' +
          '<span style="color: var(--success); font-weight: 600;">+Â¥' + (receptionist.isIntern ? '20.00' : '40.00') + '</span></div>';
      }

      orders.forEach(function (order) {
        if (order.type === 'bonus') {
          html += '<div class="balance-detail-item"><span class="balance-detail-label">ğŸ‰ å¥–é‡‘</span>' +
            '<span style="color: var(--bonus); font-weight: 600;">+Â¥' + order.amount.toFixed(2) + '</span></div>';
        } else if (order.type !== 'monthly' && order.type !== 'deduct_prepaid') {
          var rate = receptionist.commissionExpiry && new Date(receptionist.commissionExpiry) > new Date(order.date)
            ? receptionist.commissionRate
            : (order.type === 'normal' ? 5 : order.type === 'gift' ? 10 : 5);
          var commission = order.amount * (rate / 100);
          var icons = { normal: 'ğŸ“¦', gift: 'ğŸ', prepaid: 'ğŸ’³' };
          html += '<div class="balance-detail-item"><span class="balance-detail-label">' + (icons[order.type] || 'ğŸ“¦') + ' ' + getOrderTypeName(order.type) + '</span>' +
            '<span style="color: ' + getOrderTypeColor(order.type) + '; font-weight: 600;">+Â¥' + commission.toFixed(2) + '</span></div>';
        }
      });

      penalties.forEach(function (penalty) {
        html += '<div class="balance-detail-item"><span class="balance-detail-label">âš ï¸ æƒ©ç½š</span>' +
          '<span style="color: var(--danger); font-weight: 600;">-Â¥' + penalty.amount.toFixed(2) + '</span></div>';
      });

      html += '<div class="balance-detail-total"><span>ğŸ’° æ€»è®¡</span>' +
        '<span style="color: var(--accent);">Â¥' + balanceData.amount.toFixed(2) + '</span></div></div>';

      return html;
    }

    function renderPenaltiesSection(penalties) {
      if (penalties.length === 0) return '';

      var html = '<div class="card mb-5" style="border-color: var(--danger);">' +
        '<button class="btn-text" style="width: 100%; text-align: left; padding: 0;" onclick="togglePenalties()">' +
        '<div class="flex justify-between items-center">' +
        '<p style="color: var(--danger); font-size: 14px;">âš ï¸ æœ‰ ' + penalties.length + ' æ¡æƒ©ç½šè®°å½•ï¼ˆç‚¹å‡»æŸ¥çœ‹ï¼‰</p>' +
        '<span style="color: var(--danger);">' + (showPenalties ? 'â–²' : 'â–¼') + '</span></div></button>';

      if (showPenalties) {
        html += '<div style="margin-top: 12px;">';
        penalties.forEach(function (penalty) {
          html += '<div style="padding: 12px; border-radius: 8px; background: rgba(239,68,68,0.1); margin-bottom: 8px;">' +
            '<div class="flex justify-between mb-1"><span style="color: var(--danger); font-weight: 600;">-Â¥' + penalty.amount + '</span>' +
            '<span class="text-xs text-muted">' + penalty.date + '</span></div>' +
            '<p class="text-sm">åŸå› ï¼š' + penalty.reason + '</p></div>';
        });
        html += '</div>';
      }

      html += '</div>';
      return html;
    }

    function toggleBalanceDetail() {
      showBalanceDetail = !showBalanceDetail;
      renderPage();
    }

    function togglePenalties() {
      showPenalties = !showPenalties;
      renderPage();
    }

    function togglePromotionCheck(index) {
      var checks = JSON.parse(localStorage.getItem(`nyx_promo_${user.id}`) || '[false,false,false,false]');
      checks[index] = !checks[index];
      localStorage.setItem(`nyx_promo_${user.id}`, JSON.stringify(checks));
      renderPage();
    }

    async function showAnnouncement() {
      var announcements = cachedData.announcements;
      var readAnnouncements = cachedData.readAnnouncements;

      // è¿‡æ»¤7å¤©å†…çš„å…¬å‘Š
      var sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      var recentAnnouncements = announcements.filter(function (a) {
        return new Date(a.createdAt) >= sevenDaysAgo;
      }).sort(function (a, b) {
        return new Date(b.createdAt) - new Date(a.createdAt);
      });

      var html = '';
      if (recentAnnouncements.length === 0) {
        html = '<p class="text-muted text-center" style="padding: 20px;">æš‚æ— é€šçŸ¥</p>';
      } else {
        recentAnnouncements.forEach(function (a, index) {
          var isUnread = !readAnnouncements.includes(a.id);
          var isLatest = index === 0;
          html += '<div style="padding: 12px; border-radius: 10px; background: var(--bg-light); margin-bottom: 12px; border-left: 4px solid ' + (isUnread ? 'var(--accent)' : 'var(--border)') + '; position: relative;">';
          html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">';
          html += '<div>';
          if (isUnread) {
            html += '<span style="display: inline-block; background: var(--accent); color: var(--bg); font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 6px;">NEW</span>';
          }
          html += '</div>';
          if (isLatest) {
            html += '<span style="background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; font-size: 10px; padding: 3px 8px; border-radius: 4px; white-space: nowrap;">âœ¨ æœ€æ–°é€šçŸ¥</span>';
          }
          html += '</div>';
          html += '<p style="font-size: 14px; line-height: 1.6;">' + a.content + '</p>';
          html += '<p class="text-xs text-muted" style="margin-top: 8px;">' + new Date(a.createdAt).toLocaleString() + '</p>';
          html += '</div>';
        });
      }

      document.getElementById('announcementContent').innerHTML = html;
      document.getElementById('announcementModal').classList.remove('hidden');
    }

    async function closeAnnouncement() {
      // æ ‡è®°æ‰€æœ‰7å¤©å†…çš„å…¬å‘Šä¸ºå·²è¯»
      var announcements = cachedData.announcements;
      var sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

      for (const a of announcements) {
        if (new Date(a.createdAt) >= sevenDaysAgo) {
          await DataStore.markAnnouncementRead(user.id, a.id);
        }
      }

      document.getElementById('announcementModal').classList.add('hidden');
      await loadData();
      renderPage();
    }
  </script>
</body>

</html>