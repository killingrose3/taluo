<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyx Studio - æ³¨å†Œ</title>
    <meta name="description" content="Nyx Studio æ–°äººå…¥é©»æ³¨å†Œ">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <!-- èƒŒæ™¯è£…é¥° -->
    <div class="bg-decoration"></div>
    <div class="stars-container"></div>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content page-center">
        <div class="card" style="max-width: 420px; width: 100%;">
            <!-- æ ‡é¢˜ -->
            <div class="text-center mb-5">
                <h2 style="font-size: 24px; margin-bottom: 8px;">âœ¨ æ–°äººå…¥é©»</h2>
                <p class="text-muted" style="font-size: 14px;">æ¬¢è¿åŠ å…¥ Nyx Studio</p>
            </div>

            <!-- æ³¨å†Œè¡¨å• -->
            <form id="registerForm">
                <div class="form-group">
                    <label class="form-label">åç§°</label>
                    <input type="text" id="name" class="form-input" placeholder="è¯·è¾“å…¥ä½ çš„åç§°" required>
                </div>

                <!-- Emojié€‰æ‹© -->
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©ä½ çš„ä¸“å± emoji</label>
                    <button type="button" id="emojiBtn" class="form-input"
                        style="text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span id="emojiText">ç‚¹å‡»é€‰æ‹© emoji</span>
                        <span id="emojiPreview" style="font-size: 24px;">ğŸ“</span>
                    </button>
                    <input type="hidden" id="selectedEmoji" required>
                </div>

                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" id="password" class="form-input" placeholder="è®¾ç½®ä½ çš„å¯†ç " required>
                </div>

                <div id="errorMessage" class="error-message hidden"></div>

                <button type="submit" id="registerBtn" class="btn btn-primary btn-full mb-4">å®Œæˆæ³¨å†Œ</button>

                <div class="text-center">
                    <button type="button" class="btn-text" onclick="navigateTo('index.html')">
                        â† è¿”å›ç™»å½•
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Emojié€‰æ‹©å¼¹çª— -->
    <div id="emojiModal" class="modal-overlay hidden">
        <div class="card modal-content">
            <div class="modal-header">
                <h3 style="font-size: 18px;">é€‰æ‹© Emoji</h3>
                <button type="button" class="modal-close" onclick="closeEmojiModal()">Ã—</button>
            </div>

            <!-- åˆ†ç±»æ ‡ç­¾ -->
            <div class="emoji-category-tabs" id="categoryTabs"></div>

            <!-- Emoji ç½‘æ ¼ -->
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script src="utils.js"></script>
    <script>
        let currentCategory = 'ğŸ˜Š è¡¨æƒ…';

        // åˆå§‹åŒ–åˆ†ç±»æ ‡ç­¾
        function initCategoryTabs() {
            const tabsContainer = document.getElementById('categoryTabs');
            tabsContainer.innerHTML = '';

            Object.keys(emojiCategories).forEach(cat => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'emoji-category-btn' + (cat === currentCategory ? ' active' : '');
                btn.textContent = cat;
                btn.onclick = () => selectCategory(cat);
                tabsContainer.appendChild(btn);
            });
        }

        // é€‰æ‹©åˆ†ç±»
        function selectCategory(cat) {
            currentCategory = cat;
            initCategoryTabs();
            renderEmojiGrid();
        }

        // æ¸²æŸ“ emoji ç½‘æ ¼
        function renderEmojiGrid() {
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = '';

            const emojis = emojiCategories[currentCategory];
            const selectedEmoji = document.getElementById('selectedEmoji').value;

            emojis.forEach(emoji => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'emoji-btn' + (emoji === selectedEmoji ? ' selected' : '');
                btn.textContent = emoji;
                btn.onclick = () => selectEmoji(emoji);
                grid.appendChild(btn);
            });
        }

        // é€‰æ‹© emoji
        function selectEmoji(emoji) {
            document.getElementById('selectedEmoji').value = emoji;
            document.getElementById('emojiText').textContent = 'å·²é€‰æ‹©: ' + emoji;
            document.getElementById('emojiPreview').textContent = emoji;
            closeEmojiModal();
        }

        // æ‰“å¼€ emoji å¼¹çª—
        function openEmojiModal() {
            initCategoryTabs();
            renderEmojiGrid();
            document.getElementById('emojiModal').classList.remove('hidden');
        }

        // å…³é—­ emoji å¼¹çª—
        function closeEmojiModal() {
            document.getElementById('emojiModal').classList.add('hidden');
        }

        // Emoji æŒ‰é’®ç‚¹å‡»
        document.getElementById('emojiBtn').addEventListener('click', openEmojiModal);

        // æ³¨å†Œè¡¨å•å¤„ç†
        document.getElementById('registerForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const name = document.getElementById('name').value.trim();
            const emoji = document.getElementById('selectedEmoji').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('errorMessage');
            const registerBtn = document.getElementById('registerBtn');

            if (!emoji) {
                errorDiv.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ª emoji å“¦ï½';
                errorDiv.classList.remove('hidden');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            registerBtn.disabled = true;
            registerBtn.textContent = 'æ³¨å†Œä¸­...';
            errorDiv.classList.add('hidden');

            try {
                const result = await handleRegister(name, emoji, password);

                if (result.success) {
                    navigateTo('receptionist.html');
                } else {
                    errorDiv.textContent = result.message;
                    errorDiv.classList.remove('hidden');
                    registerBtn.disabled = false;
                    registerBtn.textContent = 'å®Œæˆæ³¨å†Œ';
                }
            } catch (e) {
                console.error('æ³¨å†Œè¿‡ç¨‹å‡ºé”™:', e);
                errorDiv.textContent = 'æ³¨å†Œå‡ºé”™: ' + e.message;
                errorDiv.classList.remove('hidden');
                registerBtn.disabled = false;
                registerBtn.textContent = 'å®Œæˆæ³¨å†Œ';
            }
        });
    </script>
</body>

</html>