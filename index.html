<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyx Studio - ç™»å½•</title>
    <meta name="description" content="Nyx Studio å¡”ç½—ç‰Œå·¥ä½œå®¤æ¥å¾…ç®¡ç†ç³»ç»Ÿ">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <!-- èƒŒæ™¯è£…é¥° -->
    <div class="bg-decoration"></div>
    <div class="stars-container"></div>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content page-center">
        <div class="card" style="max-width: 420px; width: 100%;">
            <!-- Logo -->
            <div class="logo-section">
                <div class="logo-icon">ğŸŒ™</div>
                <h1 class="logo-title">Nyx Studioæµ‹è¯•</h1>
                <p class="logo-subtitle">æ¥å¾…ç®¡ç†ç³»ç»Ÿ</p>
            </div>

            <!-- ç™»å½•è¡¨å• -->
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" id="username" class="form-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>

                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" id="password" class="form-input" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>

                <div id="errorMessage" class="error-message hidden"></div>

                <button type="submit" id="loginBtn" class="btn btn-primary btn-full mb-4">ç™»å½•</button>

                <div class="text-center">
                    <button type="button" class="btn-link" onclick="navigateTo('register.html')">
                        âœ¨ æ–°äººå…¥é©»ï¼Ÿåœ¨è¿™æ³¨å†Œå“¦ï¼
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script src="utils.js"></script>
    <script>
        console.log('ç™»å½•é¡µé¢å·²åŠ è½½');
        console.log('Supabase åŠ è½½çŠ¶æ€:', typeof supabaseClient !== 'undefined' ? 'æˆåŠŸ' : 'å¤±è´¥');

        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        const currentUser = DataStore.getCurrentUser();
        if (currentUser) {
            console.log('ç”¨æˆ·å·²ç™»å½•:', currentUser.name);
            if (currentUser.role === 'manager') {
                navigateTo('manager.html');
            } else {
                navigateTo('receptionist.html');
            }
        }

        // ç™»å½•è¡¨å•å¤„ç†
        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('errorMessage');
            const loginBtn = document.getElementById('loginBtn');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loginBtn.disabled = true;
            loginBtn.textContent = 'ç™»å½•ä¸­...';
            errorDiv.classList.add('hidden');

            try {
                const result = await handleLogin(username, password);
                console.log('ç™»å½•ç»“æœ:', result);

                if (result.success) {
                    console.log('ç™»å½•æˆåŠŸï¼Œç”¨æˆ·è§’è‰²:', result.user.role);
                    if (result.user.role === 'manager') {
                        window.location.href = 'manager.html';
                    } else {
                        window.location.href = 'receptionist.html';
                    }
                } else {
                    errorDiv.textContent = result.message;
                    errorDiv.classList.remove('hidden');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'ç™»å½•';
                }
            } catch (e) {
                console.error('ç™»å½•è¿‡ç¨‹å‡ºé”™:', e);
                errorDiv.textContent = 'ç™»å½•å‡ºé”™: ' + e.message;
                errorDiv.classList.remove('hidden');
                loginBtn.disabled = false;
                loginBtn.textContent = 'ç™»å½•';
            }
        });
    </script>
</body>

</html>