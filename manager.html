<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nyx Studio - ç®¡ç†è€…åå°</title>
  <meta name="description" content="Nyx Studio ç®¡ç†è€…åå°">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,500;1,400&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="bg-decoration"></div>
  <div class="stars-container"></div>

  <div class="main-content">
    <div class="container container-wide" id="pageContent"></div>
  </div>

  <script src="supabase-config.js"></script>
  <script src="utils.js"></script>
  <script>
    // å…ˆåˆå§‹åŒ–å˜é‡
    let currentView = 'home';
    let selectedReceptionist = null;
    let cachedData = { orders: [], receptionists: [], penalties: [], announcements: [] };

    // æ£€æŸ¥æƒé™
    const user = requireManager();
    if (!user) { /* ä¼šè‡ªåŠ¨è·³è½¬ */ } else { initApp(); }

    async function initApp() {
      showLoading('pageContent');
      await loadAllData();
      renderHome();
    }

    async function loadAllData() {
      const [orders, receptionists, penalties, announcements] = await Promise.all([
        DataStore.getOrders(),
        DataStore.getReceptionists(),
        DataStore.getPenalties(),
        DataStore.getAnnouncements()
      ]);
      cachedData = { orders, receptionists, penalties, announcements };
    }

    async function refreshData() {
      await loadAllData();
    }

    async function setView(view, data = null) {
      currentView = view;
      selectedReceptionist = data;
      showLoading('pageContent');
      await refreshData();
      switch (view) {
        case 'home': renderHome(); break;
        case 'reviewOrders': renderReviewOrders(); break;
        case 'dailyIncome': selectedIncomeDate = getToday(); renderDailyIncome(); break;
        case 'weeklySettlement': renderWeeklySettlement(); break;
        case 'submitBonus': renderSubmitBonus(); break;
        case 'taskManagement': renderTaskManagement(); break;
        case 'modifyCommission': renderModifyCommission(); break;
        case 'monthlyFlow': renderMonthlyFlow(); break;
        case 'manageReceptionists': renderManageReceptionists(); break;
        case 'internManagement': renderInternManagement(); break;
        case 'penalty': renderPenalty(); break;
        case 'announcement': renderAnnouncement(); break;
        case 'bossList': renderBossList(); break;
        case 'bossDetail': renderBossDetail(selectedReceptionist); break;
        case 'receptionistDetail': renderReceptionistDetail(selectedReceptionist); break;
        case 'divinerDetail': renderDivinerDetail(selectedReceptionist); break;
        case 'monthlyFlowDetail': renderMonthlyFlowDetail(selectedReceptionist); break;
        default: renderHome();
      }
    }

    function getBossBalanceSync(bossName) {
      const bossOrders = cachedData.orders.filter(o => o.bossName === bossName && o.approved !== false);
      const totalPrepaid = bossOrders.filter(o => o.type === 'prepaid').reduce((sum, o) => sum + (o.amount || 0), 0);
      const totalDeducted = bossOrders.filter(o => o.type === 'deduct_prepaid').reduce((sum, o) => sum + (o.amount || 0), 0);
      return totalPrepaid - totalDeducted;
    }

    function renderHeader() {
      return `
        <div class="page-header">
          <h1 class="page-title">ğŸ¯ ç®¡ç†è€…åå°</h1>
          <button class="btn-text" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>

        ${currentView !== 'home' ? `
          <button class="btn-text mb-4 flex items-center gap-2" onclick="setView('${(currentView === 'bossList' || currentView === 'bossDetail' || currentView === 'divinerDetail' || currentView === 'receptionistDetail') ? 'manageReceptionists' : (currentView === 'submitBonus' || currentView === 'modifyCommission') ? 'taskManagement' : 'home'}')">
            â† è¿”å›
          </button>
        ` : ''
        }
      `;
    }

    function renderHome() {
      const orders = cachedData.orders;
      const pendingCount = orders.filter(o => o.approved !== true && !o.rejectionReason).length;
      const receptionists = cachedData.receptionists.filter(r => r.role === 'receptionist' && !r.isDeleted);

      let html = renderHeader() + `<div class="card">`;

      html += `
        <div class="flex flex-col" style="gap: 20px;">
          <div style="position: relative;">
            <button class="btn btn-primary btn-full" style="justify-content: flex-start;" onclick="setView('reviewOrders')">
              âœ… å®¡æ ¸åˆ—è¡¨
            </button>
            ${pendingCount > 0 ? `<span class="notification-dot" style="position: absolute; top: 8px; right: 8px;"></span>` : ''}
          </div>
          <button class="btn btn-primary btn-full" style="justify-content: flex-start;" onclick="setView('dailyIncome')">ğŸ“Š æŸ¥çœ‹æ”¶å…¥æ˜ç»†ï¼ˆæ¯æ—¥ï¼‰</button>
          <button class="btn btn-secondary btn-full" style="justify-content: flex-start;" onclick="setView('monthlyFlow')">ğŸ“ˆ å½“æœˆæ¥å¾…ç´¯è®¡æµæ°´</button>
          <button class="btn btn-secondary btn-full" style="justify-content: flex-start;" onclick="setView('taskManagement')">ğŸ“‹ å‘¨ä»»åŠ¡å®Œæˆæ¸…å•</button>
          <button class="btn btn-accent btn-full" style="justify-content: flex-start;" onclick="setView('weeklySettlement')">ğŸ’µ å‘¨ç»“ç®—æ¸…å•</button>
          <button class="btn btn-secondary btn-full" style="justify-content: flex-start;" onclick="setView('manageReceptionists')">ğŸ” æŸ¥æ‰¾ä¿¡æ¯ä¸è¡¥å½•ä¸å®ä¹ ç®¡ç†</button>
          <button class="btn btn-secondary btn-full" style="justify-content: flex-start;" onclick="setView('announcement')">ğŸ“¢ é€šçŸ¥å…¬å‘Šç³»ç»Ÿ</button>
          <button class="btn btn-danger btn-full" style="justify-content: flex-start;" onclick="setView('penalty')">âš ï¸ æƒ©ç½šç³»ç»Ÿ</button>
        </div>
      </div>`;

      document.getElementById('pageContent').innerHTML = html;
    }

    // è€æ¿åå•è§†å›¾
    function renderBossList() {
      // é»˜è®¤åŠ è½½æ‰€æœ‰æœ‰è¿‡é¢„å­˜å•çš„è€æ¿
      const orders = cachedData.orders;
      // è·å–æ‰€æœ‰æœ‰è¿‡é¢„å­˜å•è®°å½•çš„è€æ¿åå­—ï¼ˆå»é‡ï¼‰
      // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬å®šä¹‰"æœ‰å­˜å•çš„è€æ¿"ä¸ºè‡³å°‘ä¸‹è¿‡ä¸€æ¬¡ prepaid ç±»å‹è®¢å•çš„è€æ¿
      // æˆ–è€… æ˜¯å¦åŒ…å« deduct_prepaid? é€šå¸¸æœ‰è¿‡å……å€¼è®°å½•æ‰ç®—æœ‰å­˜å•è€æ¿ã€‚
      const prepaidBosses = [...new Set(
        orders
          .filter(o => o.type === 'prepaid' && o.bossName)
          .map(o => o.bossName)
      )];

      // é¡µé¢åˆå§‹åŒ–
      let html = renderHeader() + `
        <div class="card">
          <h2 style="font-size: 18px; margin-bottom: 24px;">ğŸ“– è€æ¿åå•</h2>
          
          <!-- æœç´¢æ¡† -->
          <div style="margin-bottom: 20px; position: relative;">
            <div style="display: flex; gap: 8px; align-items: center;">
              <input type="text" id="bossListSearchInput" class="form-input" placeholder="æœç´¢è€æ¿åç§°" style="margin-bottom: 0;">
              <button id="bossListSearchBtn" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 0 8px;">ğŸ±</button>
            </div>
          </div>

          <!-- è€æ¿åˆ—è¡¨å®¹å™¨ -->
          <div id="bossListContainer" style="display: flex; flex-direction: column; gap: 12px;">
             <!-- å†…å®¹ç”± JS åŠ¨æ€å¡«å…… -->
          </div>
        </div>
      `;

      document.getElementById('pageContent').innerHTML = html;

      // æ¸²æŸ“åˆ—è¡¨å‡½æ•°
      const renderList = (filterText = '') => {
        const container = document.getElementById('bossListContainer');

        let filteredBosses = prepaidBosses;
        if (filterText) {
          filteredBosses = prepaidBosses.filter(name => name.includes(filterText));
        }

        if (filteredBosses.length === 0) {
          container.innerHTML = '<p class="text-muted text-center">æš‚æ— ç›¸å…³è€æ¿è®°å½•</p>';
          return;
        }

        container.innerHTML = filteredBosses.map(bossName => {
          const balance = getBossBalanceSync(bossName);
          // Calculate total consumption
          const bossOrders = cachedData.orders.filter(o => o.bossName === bossName);
          const totalConsumption = bossOrders.reduce((sum, o) => {
            // é¢„å­˜ã€æ­£å¸¸ã€ç¤¼ç‰©ã€æœˆå¡éƒ½ç®—åœ¨â€œåº—å†…æ€»å…±æ¶ˆè´¹â€é‡Œ
            // å”¯ç‹¬ deduct_prepaid ä¸ç®—ï¼ˆå› ä¸ºæ˜¯ç”¨å­˜æ¬¾æ¶ˆè´¹ï¼Œå·²ç»åœ¨ prepaid æ—¶ç®—è¿‡äº†? æˆ–è€…ç”¨æˆ·æ„æ€æ˜¯åªè¦èŠ±äº†é’±å°±ç®—ï¼Ÿ)
            // ç”¨æˆ·éœ€æ±‚ï¼šé¢„å­˜+æ­£å¸¸å•+æœˆå¡ï¼ˆ9.9ï¼‰+ç¤¼ç‰©ã€‚ï¼ˆæ€»å…±æ¶ˆè´¹åªç®—åŠ èµ·æ¥çš„ï¼‰
            if (o.type === 'monthly') return sum + 9.9;
            if (o.type === 'prepaid') return sum + (o.amount || 0); // é¢„å­˜ä¹Ÿç®—
            if (['normal', 'gift'].includes(o.type)) return sum + (o.amount || 0);
            // deduct_prepaid è¢«æ’é™¤
            return sum;
          }, 0);

          return `
            <div onclick="setView('bossDetail', { name: '${bossName}' })" style="background: var(--bg-light); padding: 12px; border-radius: 8px; border-left: 3px solid var(--accent); cursor: pointer;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                <span style="font-weight: bold; font-size: 16px;">è€æ¿ï¼š${bossName}</span>
                <span style="color: var(--accent); font-weight: bold;">ä½™é¢: Â¥${balance.toFixed(0)}</span>
              </div>
              <div style="font-size: 12px; color: var(--text-muted);">
                æ€»å…±åº—å†…æ¶ˆè´¹: <span style="color: var(--text);">Â¥${totalConsumption.toFixed(0)}</span>
              </div>
            </div>
          `;
        }).join('');
      };

      // åˆå§‹æ¸²æŸ“
      renderList();

      // ç»‘å®šæœç´¢äº‹ä»¶
      document.getElementById('bossListSearchBtn').addEventListener('click', () => {
        const val = document.getElementById('bossListSearchInput').value.trim();
        renderList(val);
      });

      // æ”¯æŒå›è½¦æœç´¢
      document.getElementById('bossListSearchInput').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
          const val = e.target.value.trim();
          renderList(val);
        }
        // ä¹Ÿå¯ä»¥å®æ—¶æœç´¢ï¼Œå¦‚æœéœ€è¦çš„è¯å¯ä»¥æŠŠä¸‹é¢æ³¨é‡Šæ‰“å¼€
        // const val = e.target.value.trim();
        // renderList(val);
      });
    }

    // å®¡æ ¸è®¢å•è§†å›¾
    function renderReviewOrders() {
      const orders = cachedData.orders;
      // å¾…å®¡æ ¸ï¼šapproved ä¸æ˜¯ true ä¸”æ²¡æœ‰æ‹’ç»åŸå› ï¼ˆå³æœªé€šè¿‡ã€æœªé©³å›ï¼‰
      const pendingOrders = orders.filter(o => o.approved !== true && !o.rejectionReason);
      const receptionists = cachedData.receptionists;

      let html = renderHeader() + `
        <div class="card" style="padding-bottom: 80px;">
          <h2 style="font-size: 18px; margin-bottom: 24px;">âœ… å®¡æ ¸åˆ—è¡¨</h2>
          ${pendingOrders.length === 0 ? `<p class="text-muted text-center" style="padding: 20px;">æš‚æ— å¾…å®¡æ ¸è®¢å•</p>` :
          `<div>
            <p class="text-muted mb-4">å…± ${pendingOrders.length} æ¡å¾…å®¡æ ¸</p>
            ${pendingOrders.map(order => {
            const r = receptionists.find(rec => rec.id === order.receptionistId);

            // è®¡ç®—ææˆæ•°æ®
            let recComm = 0;
            let stuComm = 0;
            let divComm = 0;
            let price = order.amount || 0;

            if (order.type === 'monthly') {
              // æœˆå¡å•ç‰¹æ®Šå¤„ç†
              price = 0;
              stuComm = 9.9;
            } else if (order.type === 'bonus') {
              recComm = order.amount;
            } else if (order.type === 'prepaid') {
              recComm = calculateCommission(order, r || { commissionRate: 5 });
              stuComm = calculateStudioIncomeForOrder(order);
              divComm = 0;
            } else {
              recComm = calculateCommission(order, r || { commissionRate: 5 });
              stuComm = calculateStudioIncomeForOrder(order);
              divComm = (price - recComm - stuComm);
            }
            const typeName = getOrderTypeName(order.type);
            const typeColor = getOrderTypeColor(order.type);

            let displayHtml = '';

            // æ ¼å¼åŒ–è¾“å‡º
            // é¢„å­˜: æ—¥æœŸï¼šxxxï¼Œè€æ¿x ï¼Œé¢„å­˜+100ã€‚å½“å‰ä½™é¢xxxï¼ˆå³è¾¹å¯¹é½ï¼‰
            if (order.type === 'prepaid') {
              displayHtml = `
                 <div style="display: flex; justify-content: space-between; align-items: center;">
                   <span>æ—¥æœŸï¼š${formatDate(order.date)}ï¼Œè€æ¿ ${order.bossName}ï¼Œé¢„å­˜ <span style="color: var(--success);">+${price}</span></span>
                   <span style="font-weight: bold; color: var(--accent);">å½“å‰ä½™é¢ï¼š${getBossBalanceSync(order.bossName).toFixed(0)}</span>
                 </div>
               `;
            }
            // æ‰£é™¤: æ—¥æœŸï¼šxxxï¼Œè€æ¿xï¼Œé—®é¢˜ï¼šxxï¼Œä½¿ç”¨-99ï¼Œå½“å‰ä½™é¢xxxï¼ˆå³è¾¹å¯¹é½ï¼‰
            else if (order.type === 'deduct_prepaid') {
              displayHtml = `
                 <div style="display: flex; justify-content: space-between; align-items: center;">
                   <span>æ—¥æœŸï¼š${formatDate(order.date)}ï¼Œè€æ¿ ${order.bossName}ï¼Œé—®é¢˜ï¼š${order.questionContent || 'æ— '}ï¼Œä½¿ç”¨ <span style="color: var(--danger);">-${price}</span></span>
                   <span style="font-weight: bold; color: var(--accent);">å½“å‰ä½™é¢ï¼š${getBossBalanceSync(order.bossName).toFixed(0)}</span>
                 </div>
               `;
            }
            // å…¶ä»–ç±»å‹ (æ­£å¸¸/ç¤¼ç‰©) - è™½ç„¶ä¸æ¶‰åŠä½™é¢å˜åŠ¨(é€šå¸¸æ˜¯ç°ç»“?) ä½†ä¸ºäº†è®°å½•å®Œæ•´æ€§è¿˜æ˜¯æ˜¾ç¤ºï¼Œæˆ–è€…æ ¹æ®ä½™é¢é€»è¾‘å®ƒä»¬ä¸å½±å“ä½™é¢ï¼Ÿ
            // å‡è®¾ Boss Balance åªå— prepaid/deduct å½±å“ã€‚
            // ä½†å¦‚æœ "æ­£å¸¸å•" ä¹Ÿæ˜¯è®°è´¦ï¼ŸåŸé€»è¾‘é‡Œ getBossBalance åªç®— prepaid - deductã€‚
            // æ‰€ä»¥è¿™é‡Œå…¶ä»–å•å­ å°±æŒ‰æ™®é€šæ˜¾ç¤ºï¼Œæˆ–è€…ä¸æ˜¾ç¤ºä½™é¢ï¼Ÿ
            // å®é™…ä¸Š getBossBalance é‡Œï¼š normal/gift ä¸å½±å“ä½™é¢
            else {
              const typeName = getOrderTypeName(order.type);
              const amountText = price;
              displayHtml = `
                 <div style="display: flex; justify-content: space-between; align-items: center;">
                   <span>æ—¥æœŸï¼š${formatDate(order.date)}ï¼Œè€æ¿ ${order.bossName}ï¼Œ${typeName} <span style="color: var(--text);">${amountText}</span></span>
                   <span style="color: var(--text-muted); font-size: 12px;">(éä½™é¢æ¶ˆè´¹)</span>
                 </div>
               `;
            }

            return `
                <div style="background: var(--bg-light); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; overflow: hidden;">
                  <!-- Header: æ¥å¾…ä¿¡æ¯ä¸æ“ä½œæŒ‰é’® -->
                  <div style="padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span style="font-size: 18px;">${r ? r.emoji : 'ğŸ‘¤'}</span>
                      <span style="font-weight: 600; font-size: 16px;">${r ? r.name : 'æœªçŸ¥'}</span>
                      <span style="background: ${typeColor}20; color: ${typeColor}; font-size: 12px; padding: 2px 8px; border-radius: 4px;">${typeName}</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                      <button onclick="rejectOrder(${order.id})" style="width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--danger); background: transparent; color: var(--danger); display: flex; align-items: center; justify-content: center; cursor: pointer;">âœ•</button>
                      <button onclick="approveOrder(${order.id})" style="width: 36px; height: 36px; border-radius: 8px; background: var(--success); border: none; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer;">âœ“</button>
                    </div>
                  </div>
                  
                  <!-- Body: è¯¦ç»†æ•°æ® -->
                   <div style="padding: 20px;">
                    <!-- é‡‘é¢æ•°æ®åŒºåŸŸ -->
                    ${order.type === 'monthly' ? `
                      <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span class="text-muted">å•å­ç±»å‹ï¼š</span>
                        <span style="color: var(--success); font-weight: 600;">æœˆå¡å•</span>
                      </div>
                       <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span class="text-muted">å·¥ä½œå®¤æ”¶å…¥ï¼š</span>
                        <span style="color: var(--success); font-weight: 600;">Â¥9.90</span>
                      </div>
                    ` : `
                       <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span class="text-muted">å•å­ä»·æ ¼ï¼š</span>
                        ${order.discount ? `
                          <span style="color: #ec4899; font-weight: 600;">Â¥${price.toFixed(0)} <span style="font-size: 12px; opacity: 0.8;">(${order.discount}æŠ˜ åŸä»·Â¥${order.originalAmount})</span></span>
                        ` : `
                          <span style="color: var(--warning); font-weight: 600;">Â¥${price.toFixed(0)}</span>
                        `}
                      </div>
                      <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span class="text-muted">æ¥å¾…ææˆï¼š</span>
                        <span style="color: var(--primary-light); font-weight: 600;">Â¥${recComm.toFixed(2)}</span>
                      </div>
                      ${order.type !== 'bonus' ? `
                      <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span class="text-muted">å åœå¸ˆææˆï¼š</span>
                        <span style="color: var(--warning); font-weight: 600;">Â¥${divComm.toFixed(2)}</span>
                      </div>
                      <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span class="text-muted">å·¥ä½œå®¤ææˆï¼š</span>
                        <span style="color: var(--success); font-weight: 600;">Â¥${stuComm.toFixed(2)}</span>
                      </div>` : ''}
                    `}

                    <!-- åˆ†å‰²çº¿ -->
                    <div style="height: 1px; background: var(--border); margin: 16px 0;"></div>

                    <!-- é—®é¢˜å†…å®¹ -->
                    <div>
                      <span class="text-muted mb-2" style="display: block;">é—®é¢˜å†…å®¹ï¼š</span>
                      <p style="color: var(--text); line-height: 1.5; font-size: 15px;">${order.questionContent || 'æ— '}</p>
                    </div>
                  </div>

                  <!-- Footer: å…ƒæ•°æ® -->
                  <div style="padding: 12px 20px; background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; font-size: 12px; color: var(--text-muted);">
                    <span>è€æ¿ï¼š${order.bossName}</span>
                    ${order.divinerId && order.divinerId !== 'æ— ' ? `<span>å åœå¸ˆï¼š${order.divinerId}</span>` : '<span></span>'}
                    <span>${order.date}</span>
                  </div>
                </div>
              `;
          }).join('')}
          </div>`
        }
        </div >
        `;
      document.getElementById('pageContent').innerHTML = html;
    }

    async function approveOrder(orderId) {
      await DataStore.approveOrder(orderId);
      await refreshData();
      renderReviewOrders();
    }

    async function rejectOrder(orderId) {
      const reason = prompt('è¯·å¡«å†™å®¡æ ¸ä¸é€šè¿‡åŸå› ï¼š');
      if (reason !== null) {  // ç”¨æˆ·æ²¡æœ‰ç‚¹å‡»å–æ¶ˆ
        const rejectionReason = reason.trim() || 'æœªå¡«å†™åŸå› ';
        await DataStore.updateOrder(orderId, {
          approved: false,
          rejectionReason: rejectionReason
        });
        await refreshData();
        renderReviewOrders();
        alert('è®¢å•å·²é©³å›ï¼Œæ¥å¾…ä¼šåœ¨é¡µé¢çœ‹åˆ°æç¤º');
      }
    }

    // æ¯æ—¥æ”¶å…¥è§†å›¾ - æ”¯æŒæ—¥æœŸé€‰æ‹©
    let selectedIncomeDate = getToday();  // é»˜è®¤ä»Šå¤©

    function renderDailyIncome(targetDate) {
      if (targetDate) selectedIncomeDate = targetDate;
      const orders = cachedData.orders;
      const displayDate = selectedIncomeDate;
      const isToday = displayDate === getToday();
      const dateOrders = orders.filter(o => o.date === displayDate && o.approved !== false);
      const receptionists = cachedData.receptionists.filter(r => r.role === 'receptionist');
      const totalIncome = calculateTotalStudioIncome(dateOrders);

      // æ ¼å¼åŒ–æ˜¾ç¤ºæ—¥æœŸ
      const dateObj = new Date(displayDate);
      const dateDisplay = isToday ? 'ä»Šæ—¥' : `${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥`;

      let html = renderHeader() + `
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 style="font-size: 18px; margin: 0;">ğŸ“Š ${dateDisplay}æ”¶å…¥æ˜ç»†</h2>
            <button onclick="showDatePicker()" style="background: var(--primary); color: #fff; border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer;">ğŸ“… é€‰æ‹©æ—¥æœŸ</button>
          </div>
          <div class="stats-section stats-section-green text-center mb-5">
            <p class="text-muted mb-2">${dateDisplay}å·¥ä½œå®¤æ”¶å…¥</p>
            <p style="font-size: 32px; font-weight: 700; color: var(--success);">Â¥${totalIncome.toFixed(2)}</p>
            <p class="text-xs text-muted mt-2">æ­£å¸¸/é¢„å­˜å•25% | ç¤¼ç‰©å•10% | æœˆå¡å•9.9å…ƒ/å•</p>
          </div>
          <h3 style="font-size: 16px; margin-bottom: 12px;">æ¥å¾…ç»Ÿè®¡</h3>
          ${receptionists.map(r => {
        const rOrders = dateOrders.filter(o => o.receptionistId === r.id);
        if (r.isDeleted && rOrders.length === 0) return '';
        const stats = {
          total: rOrders.length,
          monthly: rOrders.filter(o => o.type === 'monthly').length,
          normal: rOrders.filter(o => o.type === 'normal').length,
          prepaid: rOrders.filter(o => o.type === 'prepaid').length,
          gift: rOrders.filter(o => o.type === 'gift').length,
          bonus: rOrders.filter(o => o.type === 'bonus').length
        };

        // è®¡ç®—è¯¦ç»†æ•°æ®ä»¥ä¾¿æ¸²æŸ“
        const orderRows = rOrders.map(o => {
          let recComm = 0;
          let stuComm = 0;
          let divComm = 0;
          let price = o.amount || 0;
          const typeColor = getOrderTypeColor(o.type);

          if (o.type === 'monthly') {
            price = 0;
            stuComm = 9.9;
          } else if (o.type === 'bonus') {
            recComm = o.amount;
          } else if (o.type === 'prepaid') {
            recComm = calculateCommission(o, r);
            stuComm = calculateStudioIncomeForOrder(o);
            divComm = 0;
          } else {
            recComm = calculateCommission(o, r);
            stuComm = calculateStudioIncomeForOrder(o);
            divComm = (o.amount || 0) - recComm - stuComm;
          }

          return {
            id: o.id,
            type: getOrderTypeName(o.type),
            typeColor: typeColor,
            boss: o.bossName.replace(/ #\d+$/, ''),
            price: price,
            rec: recComm,
            stu: stuComm,
            div: divComm
          };
        });

        return `
              <div class="list-item" onclick="toggleDailyDetail('${r.id}')" style="cursor: pointer; flex-wrap: wrap;">
                <div class="list-item-header" style="width: 100%;">
                  <span class="list-item-avatar">${r.emoji}</span>
                  <div class="flex-1">
                    <span class="font-bold">${r.name}</span>
                    ${r.isIntern ? '<span class="text-xs" style="color: var(--warning); margin-left: 8px;">å®ä¹ ä¸­</span>' : ''}
                    ${r.isDeleted ? '<span class="text-xs" style="color: var(--danger);"> (å·²æ³¨é”€)</span>' : ''}
                  </div>
                  <span style="color: var(--accent);">å…± ${stats.total} å• <span style="font-size: 12px;">â–¼</span></span>
                </div>
                <div class="list-item-stats" style="width: 100%;">
                  <span class="order-type-monthly">æœˆå¡ ${stats.monthly}</span>
                  <span class="order-type-normal">æ­£å¸¸ ${stats.normal}</span>
                  <span class="order-type-prepaid">é¢„å­˜ ${stats.prepaid}</span>
                  <span class="order-type-gift">ç¤¼ç‰© ${stats.gift}</span>
                  <span class="order-type-bonus">å¥–åŠ± ${stats.bonus}</span>
                </div>
                
                <!-- è¯¦ç»†è®¢å•åˆ—è¡¨ (é»˜è®¤éšè—) -->
                <div id="dailyDetail-${r.id}" class="hidden" style="width: 100%; margin-top: 12px; padding-top: 12px;" onclick="event.stopPropagation()">
                   <div style="display: flex; flex-direction: column; gap: 8px;">
                     ${orderRows.map(row => `
                       <div style="background: var(--bg-light); border-left: 3px solid ${row.typeColor}; border-radius: 6px; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center;">
                         <div style="flex: 1;">
                           <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                             <span style="color: ${row.typeColor}; font-weight: bold; font-size: 13px;">${row.type}</span>
                             <span style="color: var(--text-muted); font-size: 12px;">è€æ¿ï¼š${row.boss}</span>
                           </div>
                           <div style="display: flex; gap: 12px; font-size: 12px; color: var(--text-muted);">
                             ${row.price > 0 ? `<span>é‡‘é¢ï¼š<span style="color: var(--text);">Â¥${row.price.toFixed(0)}</span></span>` : ''}
                             <span>å·¥ä½œå®¤ï¼š<span style="color: var(--accent);">Â¥${row.stu.toFixed(2)}</span></span>
                           </div>
                         </div>
                         <button onclick="deleteOrder(${row.id}, event)" style="background: var(--danger); color: white; border: none; border-radius: 4px; padding: 4px 10px; font-size: 11px; cursor: pointer;">åˆ é™¤</button>
                       </div>
                     `).join('')}
                     ${orderRows.length === 0 ? '<p class="text-center text-muted" style="padding: 16px;">æš‚æ— è®¢å•</p>' : ''}
                   </div>
                </div>
              </div>
            `;
      }).join('')
        }
        </div >
        `;
      document.getElementById('pageContent').innerHTML = html;
    }

    // æ—¥æœŸé€‰æ‹©å™¨
    let datePickerMonth = new Date();  // å½“å‰æ˜¾ç¤ºçš„æœˆä»½

    function showDatePicker() {
      datePickerMonth = new Date(selectedIncomeDate);  // åˆå§‹åŒ–ä¸ºå½“å‰é€‰ä¸­çš„æ—¥æœŸæ‰€åœ¨æœˆ
      renderDatePicker();
    }

    function renderDatePicker() {
      const year = datePickerMonth.getFullYear();
      const month = datePickerMonth.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startWeekday = firstDay.getDay(); // 0=å‘¨æ—¥
      const daysInMonth = lastDay.getDate();

      // è®¡ç®—å½“æœˆæ¯ä¸€å¤©çš„æ”¶å…¥ï¼Œæ‰¾å‡ºæœ€é«˜çš„ä¸€å¤©
      const orders = cachedData.orders || [];
      let dailyIncomes = {};
      let maxIncome = 0;
      let maxIncomeDate = null;

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayOrders = orders.filter(o => o.date === dateStr && o.approved !== false);
        const income = calculateTotalStudioIncome(dayOrders);
        dailyIncomes[dateStr] = income;

        if (income > maxIncome) {
          maxIncome = income;
          maxIncomeDate = dateStr;
        }
      }

      // ç”Ÿæˆæ—¥å†æ ¼å­
      let calendarHtml = '';
      const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
      calendarHtml += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center;">';

      // æ˜ŸæœŸæ ‡é¢˜
      weekdays.forEach(d => {
        calendarHtml += `<div style="font-size: 12px; color: var(--text-muted); padding: 8px 0;">${d}</div>`;
      });

      // ç©ºç™½æ ¼å­ï¼ˆæœˆåˆå‰çš„ï¼‰
      for (let i = 0; i < startWeekday; i++) {
        calendarHtml += '<div></div>';
      }

      // æ—¥æœŸæ ¼å­
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isSelected = dateStr === selectedIncomeDate;
        const isToday = dateStr === getToday();
        const isMaxIncome = dateStr === maxIncomeDate && maxIncome > 0;

        calendarHtml += `
          <div onclick="selectDate('${dateStr}')" style="padding: 8px; cursor: pointer; border-radius: 8px; position: relative;
            ${isSelected ? 'background: var(--accent); color: #000; font-weight: bold;' : ''}
            ${isToday && !isSelected ? 'border: 2px solid var(--primary);' : ''}
            transition: background 0.2s;"
            onmouseover="this.style.background = this.style.background || 'var(--bg-hover)'"
            onmouseout="this.style.background = '${isSelected ? 'var(--accent)' : ''}'">
            ${day}${isMaxIncome ? '<span style="position: absolute; top: -2px; right: -2px; font-size: 12px; color: #9d8b9e;">â˜†</span>' : ''}
          </div>
        `;
      }

      calendarHtml += '</div>';

      // åˆ›å»ºå¼¹çª—
      const existingModal = document.getElementById('datePickerModal');
      if (existingModal) existingModal.remove();

      const modal = document.createElement('div');
      modal.id = 'datePickerModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px;';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      modal.innerHTML = `
        <div style="background: var(--bg-card); border-radius: 16px; padding: 20px; max-width: 320px; width: 100%; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <button onclick="changePickerMonth(-1)" style="background: var(--bg-hover); border: none; color: var(--text); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 16px;">â—€</button>
            <span style="font-size: 16px; font-weight: 600;">${year}å¹´${month + 1}æœˆ</span>
            <button onclick="changePickerMonth(1)" style="background: var(--bg-hover); border: none; color: var(--text); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 16px;">â–¶</button>
          </div>
          ${calendarHtml}
          <button onclick="document.getElementById('datePickerModal').remove()" style="width: 100%; margin-top: 16px; padding: 10px; background: var(--bg-hover); border: none; border-radius: 8px; color: var(--text); cursor: pointer;">å–æ¶ˆ</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function changePickerMonth(delta) {
      datePickerMonth.setMonth(datePickerMonth.getMonth() + delta);
      renderDatePicker();
    }

    function selectDate(dateStr) {
      document.getElementById('datePickerModal').remove();
      renderDailyIncome(dateStr);
    }

    // åˆ é™¤è®¢å•åŠŸèƒ½
    async function deleteOrder(orderId, event) {
      // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘æŠ˜å /å±•å¼€
      if (event) {
        event.stopPropagation();
      }

      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®¢å•å—ï¼Ÿåˆ é™¤åå°†é‡æ–°è®¡ç®—æ”¶å…¥ã€‚')) {
        return;
      }

      await DataStore.deleteOrder(orderId);
      await refreshData();

      // æ ¹æ®å½“å‰è§†å›¾åˆ·æ–°æˆ–è·³è½¬
      if (currentView === 'monthlyFlowDetail' && currentDetailReceptionist && currentDetailReceptionist.id === 'all') {
        setView('monthlyFlow'); // å·¥ä½œå®¤æ€»è§ˆæ¨¡å¼åˆ é™¤åè¿”å›åˆ—è¡¨
      } else {
        // å…¶ä»–æƒ…å†µåˆ·æ–°å½“å‰è§†å›¾
        setView(currentView, selectedReceptionist || currentDetailReceptionist);
      }
    }

    // å‘¨ç»“ç®—æ¸…å•è§†å›¾
    async function renderWeeklySettlement() {
      const orders = cachedData.orders;
      const receptionists = cachedData.receptionists;
      const weekStart = getWeekStart();
      const weekOrders = orders.filter(o => new Date(o.date) >= weekStart && o.approved !== false);
      const weeklyIncome = calculateTotalStudioIncome(weekOrders);
      const settledIds = await DataStore.getSettledIds();
      const allReceptionists = receptionists.filter(r => r.role === 'receptionist');

      // è·å–æœ¬å‘¨ç»“ç®—å†å²ï¼ˆä» localStorageï¼‰
      const weekKey = formatDate(weekStart);
      const settlementHistoryKey = `nyx_settlement_history_${weekKey}`;
      let settlementHistory = JSON.parse(localStorage.getItem(settlementHistoryKey) || '{}');

      // åˆ›å»ºç»“ç®—æ¡ç›®åˆ—è¡¨
      let settlementEntries = [];

      allReceptionists.forEach(r => {
        // è·å–è¯¥æ¥å¾…æœ¬å‘¨æ‰€æœ‰è®¢å•
        const allROrders = weekOrders.filter(o => o.receptionistId === r.id);
        if (r.isDeleted && allROrders.length === 0) return;

        // è·å–è¯¥æ¥å¾…çš„ç»“ç®—æ—¶é—´æ•°ç»„ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
        const rHistory = settlementHistory[r.id] || [];
        const sortedHistory = [...rHistory].sort((a, b) => new Date(a) - new Date(b));

        if (sortedHistory.length === 0) {
          // ä»æœªç»“ç®—ï¼šæ˜¾ç¤ºæ‰€æœ‰è®¢å•
          settlementEntries.push({
            receptionist: r,
            orders: allROrders,
            isSettled: false,
            isPostSettlement: false,
            periodIndex: 0,
            label: ''
          });
        } else {
          // æœ‰ç»“ç®—å†å²ï¼šæŒ‰ç»“ç®—æ—¶é—´ç‚¹åˆ†å‰²è®¢å•
          let previousTime = 0;

          sortedHistory.forEach((settlementTime, index) => {
            const settlementTs = new Date(settlementTime).getTime();
            const periodOrders = allROrders.filter(o => {
              const orderTime = new Date(o.createdAt).getTime();
              return orderTime > previousTime && orderTime <= settlementTs;
            });

            // åˆ›å»ºå·²ç»“ç®—æ¡ç›®
            if (periodOrders.length > 0 || index === 0) {
              settlementEntries.push({
                receptionist: r,
                orders: periodOrders,
                isSettled: true,
                isPostSettlement: false,
                periodIndex: index + 1,
                label: sortedHistory.length > 1 ? `(ç¬¬${index + 1}æ¬¡ç»“ç®—)` : ''
              });
            }

            previousTime = settlementTs;
          });

          // æ£€æŸ¥æ˜¯å¦æœ‰ç»“ç®—åçš„æ–°è®¢å•
          const lastSettlementTime = new Date(sortedHistory[sortedHistory.length - 1]).getTime();
          const postOrders = allROrders.filter(o => new Date(o.createdAt).getTime() > lastSettlementTime);

          if (postOrders.length > 0) {
            settlementEntries.push({
              receptionist: r,
              orders: postOrders,
              isSettled: false,
              isPostSettlement: true,
              periodIndex: sortedHistory.length + 1,
              label: '(ç»“ç®—åæ–°å¢)'
            });
          }
        }
      });

      // æ’åºï¼šæœ‰é‡‘é¢ä¼˜å…ˆã€é‡‘é¢å¤§ä¼˜å…ˆã€å·²ç»“ç®—æ’æœ€å
      settlementEntries.sort((a, b) => {
        // å·²ç»“ç®—æ’æœ€å
        if (a.isSettled && !b.isSettled) return 1;
        if (!a.isSettled && b.isSettled) return -1;

        // è®¡ç®—é‡‘é¢
        const amountA = a.orders.reduce((sum, o) => sum + calculateCommission(o, a.receptionist || {}), 0);
        const amountB = b.orders.reduce((sum, o) => sum + calculateCommission(o, b.receptionist || {}), 0);

        // æœ‰é‡‘é¢çš„ä¼˜å…ˆï¼Œé‡‘é¢å¤§çš„ä¼˜å…ˆ
        if (amountA === 0 && amountB > 0) return 1;
        if (amountA > 0 && amountB === 0) return -1;
        return amountB - amountA;  // é‡‘é¢ä»å¤§åˆ°å°
      });

      let html = renderHeader() + `
        <div class="card">
          <h2 style="font-size: 18px; margin-bottom: 16px;">ğŸ’µ å‘¨ç»“ç®—æ¸…å•</h2>
          <div class="stats-section stats-section-green text-center mb-5" style="cursor: pointer;">
            <p class="text-muted mb-2">æœ¬å‘¨å·¥ä½œå®¤æ”¶å…¥</p>
            <p style="font-size: 32px; font-weight: 700; color: var(--success);">Â¥${weeklyIncome.toFixed(2)}</p>
          </div>
          <h3 style="font-size: 16px; margin-bottom: 12px;">æ¥å¾…ç»Ÿè®¡</h3>
          ${settlementEntries.map(entry => {
        const r = entry.receptionist;
        const rOrders = entry.orders;
        const isSettled = entry.isSettled;

        const stats = {
          monthly: rOrders.filter(o => o.type === 'monthly').length,
          normal: rOrders.filter(o => o.type === 'normal').length,
          prepaid: rOrders.filter(o => o.type === 'prepaid').length,
          gift: rOrders.filter(o => o.type === 'gift').length,
          bonus: rOrders.filter(o => o.type === 'bonus').length
        };

        // å¼ºåˆ¶ä»»åŠ¡ï¼š3å•æœˆå¡
        const mandatoryTaskComplete = stats.monthly >= 3;
        const baseSalary = r.isIntern ? 20 : 40;

        // è®¡ç®—å‘¨æµæ°´
        const weeklyFlow = rOrders.reduce((sum, o) => {
          if (o.type === 'monthly') return sum + 9.9;
          if (o.type === 'bonus') return sum;
          return sum + (o.amount || 0);
        }, 0);

        // è®¡ç®—é¢„å­˜æ€»é¢
        const prepaidTotal = rOrders.filter(o => o.type === 'prepaid').reduce((sum, o) => sum + (o.amount || 0), 0);

        // é¢å¤–ä»»åŠ¡æ£€æŸ¥ï¼ˆåªæœ‰å®Œæˆå¼ºåˆ¶ä»»åŠ¡æ‰è®¡ç®—å¥–åŠ±ï¼‰
        const flowTaskComplete = weeklyFlow >= 500;
        const prepaidTaskComplete = prepaidTotal >= 666;
        const monthlyTaskComplete = stats.monthly >= 9;

        // è®¡ç®—å•å­ææˆ
        let orderCommission = 0;
        rOrders.forEach(order => {
          if (order.type !== 'bonus' && order.type !== 'monthly') {
            const rate = r.commissionExpiry && new Date(r.commissionExpiry) > new Date(order.date) ? r.commissionRate : (order.type === 'normal' ? 5 : order.type === 'gift' ? 10 : 5);
            orderCommission += order.amount * (rate / 100);
          }
        });

        // å¥–åŠ±é‡‘é¢ï¼ˆä»è®¢å•ä¸­è·å–çš„bonusç±»å‹ï¼‰
        const bonusAmount = rOrders.filter(o => o.type === 'bonus').reduce((sum, o) => sum + o.amount, 0);

        // æƒ©ç½šé‡‘é¢
        const weeklyPenalties = (r.penalties || []).filter(p => new Date(p.date) >= weekStart);
        const penaltyAmount = isSettled ? 0 : weeklyPenalties.reduce((sum, p) => sum + p.amount, 0);

        // é¢å¤–ä»»åŠ¡å¥–åŠ±ï¼ˆåªæœ‰å®Œæˆå¼ºåˆ¶ä»»åŠ¡æ‰è®¡ç®—ï¼‰
        let extraBonus = 0;
        let extraBonusDetails = [];
        if (mandatoryTaskComplete) {
          if (flowTaskComplete) {
            extraBonus += 15;
            extraBonusDetails.push('å‘¨æµæ°´500+');
          }
          if (prepaidTaskComplete) {
            extraBonus += 15;
            extraBonusDetails.push('é¢„å­˜666+');
          }
          if (monthlyTaskComplete) {
            extraBonus += 15;
            extraBonusDetails.push('æœˆå¡9å•+');
          }
        }

        // å¦‚æœå¼ºåˆ¶ä»»åŠ¡æœªå®Œæˆï¼Œä¸ç»“ç®—åº•è–ªï¼Œä½†ææˆå’Œå¥–åŠ±æ­£å¸¸ç»“ç®—
        const actualBaseSalary = mandatoryTaskComplete ? baseSalary : 0;
        const totalSalary = Math.max(0, actualBaseSalary + orderCommission + bonusAmount + extraBonus - penaltyAmount);

        return `
              <div class="list-item" style="${isSettled ? 'background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); opacity: 0.7;' : entry.isPostSettlement ? 'border: 2px solid var(--accent);' : ''}">
                <div class="list-item-header">
                  <span class="list-item-avatar">${r.emoji}</span>
                  <div class="flex-1">
                    <span class="font-bold">${r.name}</span>
                    ${entry.label ? `<span class="text-xs" style="color: ${entry.isPostSettlement ? 'var(--accent)' : 'var(--success)'}; margin-left: 8px;">${entry.label}</span>` : ''}
                    ${r.isIntern ? '<span class="text-xs" style="color: var(--warning); margin-left: 8px;">å®ä¹ </span>' : ''}
                    ${r.isDeleted ? '<span class="text-xs" style="color: var(--danger); margin-left: 8px;">(å·²æ³¨é”€)</span>' : ''}
                  </div>
                  ${!r.isDeleted ? `
                    <button class="settle-checkbox ${isSettled ? 'checked' : ''}" onclick="${isSettled ? `undoSettlement('${r.id}')` : `toggleSettlement('${r.id}')`}" style="${isSettled ? 'background: var(--success); border-color: var(--success);' : ''}">
                      ${isSettled ? 'âœ“' : ''}
                    </button>
                  ` : ''}
                </div>
                <div class="list-item-stats mb-3">
                  <span class="order-type-monthly">æœˆå¡ ${stats.monthly}</span>
                  <span class="order-type-normal">æ­£å¸¸ ${stats.normal}</span>
                  <span class="order-type-prepaid">é¢„å­˜ ${stats.prepaid}</span>
                  <span class="order-type-gift">ç¤¼ç‰© ${stats.gift}</span>
                  <span class="order-type-bonus">å¥–åŠ± ${stats.bonus}</span>
                </div>
                
                <!-- ä»»åŠ¡å®ŒæˆçŠ¶æ€ -->
                <div style="margin-bottom: 12px; padding: 8px; background: var(--bg-light); border-radius: 8px; font-size: 12px;">
                  <div style="margin-bottom: 4px; font-weight: bold; color: ${mandatoryTaskComplete ? 'var(--success)' : 'var(--danger)'};">
                    ${mandatoryTaskComplete ? 'âœ“' : 'âœ—'} å¼ºåˆ¶ä»»åŠ¡ï¼šæœˆå¡3å• (${stats.monthly}/3)
                  </div>
                  <div style="display: flex; flex-wrap: wrap; gap: 8px; color: var(--text-muted);">
                    <span style="color: ${mandatoryTaskComplete && flowTaskComplete ? 'var(--success)' : 'var(--text-muted)'};">
                      ${mandatoryTaskComplete && flowTaskComplete ? 'âœ“' : 'â—‹'} å‘¨æµæ°´500 (Â¥${weeklyFlow.toFixed(0)})
                    </span>
                    <span style="color: ${mandatoryTaskComplete && prepaidTaskComplete ? 'var(--success)' : 'var(--text-muted)'};">
                      ${mandatoryTaskComplete && prepaidTaskComplete ? 'âœ“' : 'â—‹'} é¢„å­˜666 (Â¥${prepaidTotal.toFixed(0)})
                    </span>
                    <span style="color: ${mandatoryTaskComplete && monthlyTaskComplete ? 'var(--success)' : 'var(--text-muted)'};">
                      ${mandatoryTaskComplete && monthlyTaskComplete ? 'âœ“' : 'â—‹'} æœˆå¡9å• (${stats.monthly}/9)
                    </span>
                  </div>
                </div>
                
                <div class="salary-detail">
                  <div class="salary-row"><span class="text-muted">åº•è–ªï¼š</span><span ${!mandatoryTaskComplete ? 'style="color: var(--danger);"' : ''}>${mandatoryTaskComplete ? 'Â¥' + actualBaseSalary : 'Â¥0 <span style="font-size: 12px; text-decoration: line-through; opacity: 0.5;">(' + baseSalary + ')</span>'}</span></div>
                  <div class="salary-row"><span class="text-muted">å•å­ææˆï¼š</span><span style="color: var(--accent);">Â¥${orderCommission.toFixed(2)}</span></div>
                  <div class="salary-row"><span class="text-muted">è®¢å•å¥–åŠ±ï¼š</span><span style="color: ${bonusAmount > 0 ? 'var(--bonus)' : 'var(--text)'};">Â¥${bonusAmount.toFixed(2)}</span></div>
                  ${extraBonus > 0 ? `<div class="salary-row"><span class="text-muted">ä»»åŠ¡å¥–åŠ±ï¼š</span><span style="color: var(--success);">+Â¥${extraBonus} (${extraBonusDetails.join(', ')})</span></div>` : ''}
                  <div class="salary-row"><span class="text-muted">æƒ©ç½šé¡¹ï¼š</span><span style="color: ${penaltyAmount > 0 ? 'var(--danger)' : 'var(--text)'};">${penaltyAmount > 0 ? '-' : ''}Â¥${penaltyAmount.toFixed(2)}</span></div>
                  <div class="salary-total">
                    <span>æ€»å…±ç»“ç®—å·¥èµ„ï¼š</span>
                    <span style="color: var(--accent);">Â¥${totalSalary.toFixed(2)}${!mandatoryTaskComplete ? ' (æœªå®Œæˆå¼ºåˆ¶ä»»åŠ¡)' : ''}</span>
                  </div>
                </div>
                ${isSettled ? '<p class="text-center text-xs mt-2" style="color: var(--success);">âœ“ å·²ç»“ç®—</p>' : ''}
              </div>
            `;
      }).join('')
        }
        </div >
        `;
      document.getElementById('pageContent').innerHTML = html;
    }

    async function toggleSettlement(rid) {
      const receptionist = cachedData.receptionists.find(r => r.id === rid);
      const receptionistName = receptionist?.name || 'è¯¥æ¥å¾…';

      // è·å–æœ¬å‘¨ç»“ç®—å†å²
      const weekStart = getWeekStart();
      const weekKey = formatDate(weekStart);
      const settlementHistoryKey = `nyx_settlement_history_${weekKey}`;
      let settlementHistory = JSON.parse(localStorage.getItem(settlementHistoryKey) || '{}');

      const rHistory = settlementHistory[rid] || [];
      const newSettlementDate = new Date().toISOString();

      // æ·»åŠ æ–°çš„ç»“ç®—æ—¶é—´åˆ°å†å²
      rHistory.push(newSettlementDate);
      settlementHistory[rid] = rHistory;
      localStorage.setItem(settlementHistoryKey, JSON.stringify(settlementHistory));

      // æ›´æ–°æ•°æ®åº“ä¸­çš„ lastSettlementDate
      const updateResult = await DataStore.updateReceptionist(rid, {
        lastSettlementDate: newSettlementDate
      });

      // ç¡®ä¿ settledIds åŒ…å«æ­¤æ¥å¾…
      const settledIds = await DataStore.getSettledIds();
      if (!settledIds.includes(rid)) {
        await DataStore.setSettled(rid, true);
      }

      localStorage.removeItem(`nyx_promo_${rid}`);

      if (updateResult) {
        const settlementCount = rHistory.length;
        alert(`âœ… ${receptionistName} ç¬¬${settlementCount}æ¬¡ç»“ç®—å®Œæˆï¼\n\næ¥å¾…å‘˜åˆ·æ–°é¡µé¢åä½™é¢å°†é‡ç½®ã€‚`);
      } else {
        alert(`âŒ ç»“ç®—å¤±è´¥ï¼è¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ã€‚`);
      }

      await refreshData();
      renderWeeklySettlement();
    }

    // æ’¤é”€æœ€åä¸€æ¬¡ç»“ç®—
    async function undoLastSettlement(rid) {
      const receptionist = cachedData.receptionists.find(r => r.id === rid);
      const receptionistName = receptionist?.name || 'è¯¥æ¥å¾…';

      // è·å–æœ¬å‘¨ç»“ç®—å†å²
      const weekStart = getWeekStart();
      const weekKey = formatDate(weekStart);
      const settlementHistoryKey = `nyx_settlement_history_${weekKey}`;
      let settlementHistory = JSON.parse(localStorage.getItem(settlementHistoryKey) || '{}');

      const rHistory = settlementHistory[rid] || [];
      if (rHistory.length > 0) {
        rHistory.pop(); // ç§»é™¤æœ€åä¸€æ¬¡ç»“ç®—
        settlementHistory[rid] = rHistory;
        localStorage.setItem(settlementHistoryKey, JSON.stringify(settlementHistory));

        // æ›´æ–° lastSettlementDate ä¸ºä¸Šä¸€æ¬¡ç»“ç®—æ—¶é—´æˆ– null
        const newLastDate = rHistory.length > 0 ? rHistory[rHistory.length - 1] : null;
        await DataStore.updateReceptionist(rid, { lastSettlementDate: newLastDate });

        if (rHistory.length === 0) {
          await DataStore.setSettled(rid, false);
        }

        alert(`â†©ï¸ ${receptionistName} æœ€åä¸€æ¬¡ç»“ç®—å·²æ’¤é”€`);
      }

      await refreshData();
      renderWeeklySettlement();
    }

    // å–æ¶ˆç»“ç®—ï¼ˆä»UIè°ƒç”¨ï¼‰
    async function undoSettlement(rid) {
      const receptionist = cachedData.receptionists.find(r => r.id === rid);
      const receptionistName = receptionist?.name || 'è¯¥æ¥å¾…';

      if (confirm(`ç¡®å®šå–æ¶ˆ ${receptionistName} çš„ç»“ç®—çŠ¶æ€å—ï¼Ÿ\n\næ¥å¾…å‘˜é¡µé¢ä½™é¢å°†æ¢å¤åˆ°ç»“ç®—å‰çŠ¶æ€ã€‚`)) {
        await undoLastSettlement(rid);
      }
    }

    // æäº¤å¥–é‡‘è§†å›¾
    function renderSubmitBonus() {
      const receptionists = cachedData.receptionists.filter(r => r.role === 'receptionist' && !r.isDeleted);
      let html = renderHeader() + `
        <div class="card">
          <h2 style="font-size: 18px; margin-bottom: 16px;">ğŸ æäº¤å¥–é‡‘</h2>
          <div id="bonusSuccess" class="success-message hidden">âœ¨ å¥–é‡‘å·²å‘æ”¾ï¼</div>
          <form id="bonusForm">
            <div class="form-group">
              <label class="form-label">é€‰æ‹©æ¥å¾…</label>
              <select id="bonusReceptionist" class="form-select" required>
                <option value="">è¯·é€‰æ‹©æ¥å¾…</option>
                ${receptionists.map(r => `<option value="${r.id}">${r.emoji} ${r.name}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">å¥–é‡‘ç±»å‹</label>
              <select id="bonusType" class="form-select">
                <option value="tea">ğŸ§‹ å¥¶èŒ¶</option>
                <option value="psychology">ğŸ’š å¿ƒç†å§”å‘˜è¡¥åŠ©</option>
                <option value="recruitment">ğŸŒŸ æ‹›æ–°ææˆ</option>
                <option value="weeklyReward">ğŸ† å‘¨ä»»åŠ¡å¥–åŠ±</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">é‡‘é¢</label>
              <input type="number" id="bonusAmount" class="form-input" placeholder="è¯·è¾“å…¥é‡‘é¢" step="0.01" required>
            </div>
            <button type="submit" class="btn btn-accent btn-full">ç¡®è®¤å‘æ”¾</button>
          </form>
        </div >
        `;
      document.getElementById('pageContent').innerHTML = html;
      document.getElementById('bonusForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const rid = document.getElementById('bonusReceptionist').value;
        const amount = parseFloat(document.getElementById('bonusAmount').value);
        if (!rid || !amount) return;

        await DataStore.saveOrder({
          receptionistId: rid,
          type: 'bonus',
          bonusType: document.getElementById('bonusType').value,
          amount,
          date: getToday(),
          bossName: 'ç³»ç»Ÿå¥–åŠ±',
          approved: true
        });

        document.getElementById('bonusSuccess').classList.remove('hidden');
        setTimeout(async () => {
          const successMsg = document.getElementById('bonusSuccess');
          if (successMsg) successMsg.classList.add('hidden');

          const form = document.getElementById('bonusForm');
          if (form) form.reset();

          await refreshData();
        }, 2000);
      });
    }

    // å‘¨ä»»åŠ¡å®Œæˆæ¸…å•
    function renderTaskManagement() {
      const orders = cachedData.orders;
      const receptionists = cachedData.receptionists.filter(r => r.role === 'receptionist' && !r.isDeleted);
      const weekStart = getWeekStart();

      const getWeeklyMonthlyCount = (rid) => orders.filter(o => o.receptionistId === rid && o.type === 'monthly' && new Date(o.date) >= weekStart && o.approved !== false).length;
      const getWeeklyFlow = (rid) => orders.filter(o => o.receptionistId === rid && (o.type === 'normal' || o.type === 'prepaid') && new Date(o.date) >= weekStart && o.approved !== false).reduce((sum, o) => sum + (o.amount || 0), 0);

      const redZone = receptionists.filter(r => getWeeklyMonthlyCount(r.id) < 3);
      const greenZone = receptionists.filter(r => getWeeklyMonthlyCount(r.id) >= 3);
      const yellowZone = receptionists.filter(r => getWeeklyMonthlyCount(r.id) >= 3 && (getWeeklyMonthlyCount(r.id) >= 9 || getWeeklyFlow(r.id) >= 666));

      let html = renderHeader() + `
        <div class="card">
          <h2 style="font-size: 18px; margin-bottom: 16px;">ğŸ“‹ å‘¨ä»»åŠ¡å®Œæˆæ¸…å•</h2>
          <div class="stats-section stats-section-red mb-4">
            <h3 class="stats-section-title" style="color: var(--danger);">ğŸ”´ æœªå®Œæˆ å‘¨ä»»åŠ¡æœˆå¡x3</h3>
            ${redZone.length === 0 ? '<p class="text-muted text-sm">æš‚æ— </p>' : redZone.map(r => `
              <div class="flex justify-between items-center" style="padding: 8px 0;">
                <span>${r.emoji} ${r.name}</span>
                <span style="color: var(--danger);">${getWeeklyMonthlyCount(r.id)}/3 å•</span>
              </div>
            `).join('')}
          </div>
          <div class="stats-section stats-section-green mb-4">
            <h3 class="stats-section-title" style="color: var(--success);">ğŸŸ¢ å·²å®Œæˆ å‘¨ä»»åŠ¡æœˆå¡x3</h3>
            ${greenZone.length === 0 ? '<p class="text-muted text-sm">æš‚æ— </p>' : greenZone.map(r => `
              <div class="flex justify-between items-center" style="padding: 8px 0;">
                <span>${r.emoji} ${r.name}</span>
                <span style="color: var(--success);">${getWeeklyMonthlyCount(r.id)} å•</span>
              </div>
            `).join('')}
          </div>
          <div class="stats-section stats-section-yellow">
            <h3 class="stats-section-title" style="color: var(--warning);">ğŸŸ¡ å®Œæˆé¢å¤–ç›®æ ‡ï¼ˆæœˆå¡â‰¥9 æˆ– å‘¨æµæ°´â‰¥666ï¼‰</h3>
            ${yellowZone.length === 0 ? '<p class="text-muted text-sm">æš‚æ— </p>' : yellowZone.map(r => `
              <div class="flex justify-between items-center" style="padding: 8px 0;">
                <span>${r.emoji} ${r.name}</span>
                <div class="flex gap-2 items-center">
                  <span class="order-type-monthly text-xs">${getWeeklyMonthlyCount(r.id)}å•</span>
                  <span class="order-type-bonus text-xs">Â¥${getWeeklyFlow(r.id).toFixed(0)}</span>
                  <span>ğŸ‰</span>
                </div>
              </div>
            `).join('')}
          </div>
          
          <div style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px;">
             <p class="text-sm text-muted mb-3">å…¶ä»–ç®¡ç†</p>
             <div class="flex gap-3">
               <button class="btn btn-secondary flex-1" onclick="setView('submitBonus')">ğŸ æäº¤å¥–é‡‘</button>
               <button class="btn btn-secondary flex-1" onclick="setView('modifyCommission')">ğŸ’° ä¿®æ”¹ææˆ</button>
             </div>
          </div>
        </div >
        `;
      document.getElementById('pageContent').innerHTML = html;
    }

    // ä¿®æ”¹ææˆè§†å›¾
    function renderModifyCommission() {
      const receptionists = cachedData.receptionists.filter(r => r.role === 'receptionist' && !r.isDeleted);
      let html = renderHeader() + `
        <div class="card">
          <h2 style="font-size: 18px; margin-bottom: 16px;">ğŸ’° ä¿®æ”¹ææˆ</h2>
          <div id="commissionSuccess" class="success-message hidden">âœ¨ ææˆå·²ä¿®æ”¹ï¼Œ7å¤©åæ¢å¤é»˜è®¤</div>
          ${(function () {
          const withTempCommission = receptionists.filter(r => r.commissionExpiry && new Date(r.commissionExpiry) > new Date());
          if (withTempCommission.length > 0) {
            return `
                <div class="alert-banner alert-banner-accent mb-4">
                  <p style="margin-bottom: 8px;">ğŸ’° ä¸´æ—¶ææˆä¸­çš„æ¥å¾…ï¼š</p>
                  ${withTempCommission.map(r => {
              const d = new Date(r.commissionExpiry);
              return `<p class="text-sm">${r.emoji} ${r.name}ï¼ˆææˆ${r.commissionRate}%ï¼Œ${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥ç»“æŸï¼‰</p>`;
            }).join('')}
                </div>
              `;
          }
          return '';
        })()
        }
      <form id="commissionForm">
        <div class="form-group">
          <label class="form-label">é€‰æ‹©æ¥å¾…</label>
          <select id="commissionReceptionist" class="form-select" required>
            <option value="">è¯·é€‰æ‹©æ¥å¾…</option>
            ${receptionists.map(r => `<option value="${r.id}">${r.emoji} ${r.name}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">æ–°ææˆæ¯”ä¾‹ï¼ˆ%ï¼‰</label>
          <input type="number" id="newRate" class="form-input" placeholder="è¯·è¾“å…¥æ–°ææˆæ¯”ä¾‹" required>
        </div>
        <p class="text-sm text-muted mb-4">âš ï¸ ä¿®æ”¹åæœ‰æ•ˆæœŸä¸º7å¤©ï¼Œä¹‹åè‡ªåŠ¨æ¢å¤é»˜è®¤æ¯”ä¾‹</p>
        <button type="submit" class="btn btn-primary btn-full">ç¡®è®¤ä¿®æ”¹</button>
      </form>
        </div >
        `;
      document.getElementById('pageContent').innerHTML = html;
      document.getElementById('commissionForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const rid = document.getElementById('commissionReceptionist').value;
        const newRate = parseFloat(document.getElementById('newRate').value);
        if (!rid || !newRate) return;
        const expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + 7);

        await DataStore.updateReceptionist(rid, {
          commissionRate: newRate,
          commissionExpiry: expiryDate.toISOString()
        });

        document.getElementById('commissionSuccess').classList.remove('hidden');
        setTimeout(async () => {
          const successMsg = document.getElementById('commissionSuccess');
          if (successMsg) successMsg.classList.add('hidden');

          const form = document.getElementById('commissionForm');
          if (form) form.reset();

          await refreshData();
        }, 2000);
      });
    }

    // å½“æœˆæµæ°´è§†å›¾ - çŠ¶æ€å˜é‡
    let currentDetailDate = new Date();
    let selectedDetailDate = null;
    let currentDetailReceptionist = null;

    function renderMonthlyFlow() {
      const receptionists = cachedData.receptionists.filter(r => r.role === 'receptionist');

      // Calculate total studio income for the month (as header)
      const orders = cachedData.orders;
      const monthStart = getMonthStart();
      const monthOrders = orders.filter(o => o.approved !== false && new Date(o.createdAt) >= monthStart);
      const totalStudioIncome = calculateTotalStudioIncome(monthOrders);
      const totalMonthlyCards = monthOrders.filter(o => o.type === 'monthly').length;

      const getStats = (rid) => {
        const rOrders = monthOrders.filter(o => o.receptionistId === rid);
        const totalAmount = rOrders.reduce((sum, o) => {
          if (o.type === 'monthly') return sum + 9.9;
          if (o.type === 'bonus') return sum;
          return sum + (o.amount || 0);
        }, 0);
        return {
          totalAmount,
          monthly: rOrders.filter(o => o.type === 'monthly').length,
          normal: rOrders.filter(o => o.type === 'normal').length,
          prepaid: rOrders.filter(o => o.type === 'prepaid').length,
          gift: rOrders.filter(o => o.type === 'gift').length,
          bonus: rOrders.filter(o => o.type === 'bonus').length,
          total: rOrders.length
        };
      };

      // Sort receptionists by total flow
      const sorted = [...receptionists].sort((a, b) => getStats(b.id).totalAmount - getStats(a.id).totalAmount);

      let html = renderHeader() + `
        <div class="card">
          <h2 style="font-size: 18px; margin-bottom: 16px;">ğŸ“ˆ å½“æœˆæ¥å¾…ç´¯è®¡æµæ°´</h2>
          <div class="stats-section" onclick="setView('monthlyFlowDetail', { id: 'all', name: 'å·¥ä½œå®¤æ€»è§ˆ' })" style="background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,215,0,0.08)); border: 1px solid rgba(255,215,0,0.25); text-align: center; margin-bottom: 20px; cursor: pointer;">
             <p class="text-muted mb-2">æœ¬æœˆå·¥ä½œå®¤æ”¶å…¥</p>
             <p style="font-size: 32px; font-weight: 700; color: var(--accent);">Â¥${totalStudioIncome.toFixed(2)}</p>
             <p style="font-size: 14px; color: var(--success); margin-top: 8px;">å…±è®¡ ${totalMonthlyCards} ä¸ªæœˆå¡</p>
             <p class="text-xs text-muted mt-2">æ­£å¸¸/é¢„å­˜å•25% | ç¤¼ç‰©å•10% | æœˆå¡å•9.9å…ƒ/å•</p>
             <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">ç‚¹å‡»æŸ¥çœ‹ â–¶</p>
          </div>
          
          <div style="display: flex; flex-direction: column; gap: 12px;">
            ${sorted.map(r => {
        const stats = getStats(r.id);
        return `
                 <div onclick="setView('monthlyFlowDetail', { id: '${r.id}', name: '${r.name}' })" style="background: var(--bg-light); padding: 16px; border-radius: 12px; border: 1px solid var(--border); cursor: pointer;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                       <span style="font-weight: bold; font-size: 16px;">${r.emoji} ${r.name} ${r.isIntern ? '<span style="font-size: 12px; color: var(--warning); margin-left: 4px;">å®ä¹ ä¸­</span>' : ''} <span style="font-size: 12px; color: var(--text-muted); margin-left: 4px;">ç‚¹å‡»æŸ¥çœ‹ â–¶</span></span>
                    </div>
                    <div style="margin-bottom: 12px;">
                       <p class="text-muted" style="font-size: 12px; margin-bottom: 2px;">æ€»æµæ°´ï¼š</p>
                       <p style="font-size: 20px; font-weight: bold; color: var(--text);">Â¥${stats.totalAmount.toFixed(2)}</p>
                    </div>
                    <div style="font-size: 13px; display: flex; gap: 8px; flex-wrap: wrap;">
                       <span style="color: #10b981;">æœˆå¡ ${stats.monthly}</span>
                       <span style="color: #3b82f6;">æ­£å¸¸ ${stats.normal}</span>
                       <span style="color: #f59e0b;">é¢„å­˜ ${stats.prepaid}</span>
                       <span style="color: #ec4899;">ç¤¼ç‰© ${stats.gift}</span>
                       <span style="color: #ffd700;">å¥–åŠ± ${stats.bonus}</span>
                    </div>
                 </div>
           `;
      }).join('')}
          </div>
        </div>
      `;
      document.getElementById('pageContent').innerHTML = html;
    }

    // æœˆåº¦æµæ°´è¯¦æƒ…è§†å›¾ (æ—¥å†ç‰ˆ)
    function renderMonthlyFlowDetail(data) {
      if (data) {
        currentDetailReceptionist = data;
        currentDetailDate = new Date();
        selectedDetailDate = null;
      }

      const r = currentDetailReceptionist;
      if (!r) { setView('monthlyFlow'); return; }

      const year = currentDetailDate.getFullYear();
      const month = currentDetailDate.getMonth();
      const daysInMonth = getDaysInMonth(year, month);
      const firstDay = new Date(year, month, 1).getDay();

      let orders;
      if (r.id === 'all') {
        orders = cachedData.orders.filter(o => o.approved !== false);
      } else {
        const targetId = String(r.id);
        orders = cachedData.orders.filter(o => String(o.receptionistId) === targetId && o.approved !== false);
      }

      let selectedOrders = selectedDetailDate ? getOrdersForDate(selectedDetailDate, orders, year, month) : [];

      // If showing all, sort by receptionist to keep them together
      if (r.id === 'all') {
        selectedOrders.sort((a, b) => {
          if (a.receptionistId !== b.receptionistId) return a.receptionistId - b.receptionistId;
          return 0;
        });
      }

      let html = renderHeader() + `
          <div class="card mb-4">
             <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                <button class="btn-text" onclick="setView('monthlyFlow')">â† è¿”å›æµæ°´åˆ—è¡¨</button>
             </div>
             <h2 style="font-size: 18px; margin-bottom: 16px;">ğŸ“… ${r.name} çš„è®¢å•è®°å½•</h2>
             
             <!-- Calendar Nav -->
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <button class="btn-icon" onclick="prevDetailMonth()" style="background: var(--bg-light); border: 1px solid var(--border); width: 32px; height: 32px; border-radius: 8px; color: var(--text);">â—€</button>
                <span style="font-size: 16px; font-weight: bold;">${year}å¹´${month + 1}æœˆ</span>
                <button class="btn-icon" onclick="nextDetailMonth()" style="background: var(--bg-light); border: 1px solid var(--border); width: 32px; height: 32px; border-radius: 8px; color: var(--text);">â–¶</button>
             </div>

             <!-- Weekdays -->
             <div style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                ${['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => `<div>${d}</div>`).join('')}
             </div>

             <!-- Days -->
             <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
                ${Array.from({ length: firstDay }).map(() => '<div></div>').join('')}
                ${(() => {
          // Calculate max studio income for the month (only for Studio Overview)
          let dailyIncomes = [];
          let maxIncome = 0;
          if (r.id === 'all') {
            dailyIncomes = Array.from({ length: daysInMonth }).map((_, i) => {
              const d = i + 1;
              const dOrders = getOrdersForDate(d, orders, year, month);
              return calculateTotalStudioIncome(dOrders);
            });
            maxIncome = Math.max(...dailyIncomes);
          }

          return Array.from({ length: daysInMonth }).map((_, i) => {
            const day = i + 1;
            const dayOrders = getOrdersForDate(day, orders, year, month);
            const isToday = formatDate(new Date()) === `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isSelected = selectedDetailDate === day;
            const hasOrders = dayOrders.length > 0;

            const isMaxIncomeDay = r.id === 'all' && maxIncome > 0 && dailyIncomes[i] === maxIncome;

            const orderTypes = [...new Set(dayOrders.map(o => o.type))];

            return `
                      <div onclick="selectDetailDate(${day})" style="
                          aspect-ratio: 1; 
                          display: flex; 
                          flex-direction: column; 
                          align-items: center; 
                          justify-content: center; 
                          border-radius: 8px; 
                          cursor: pointer; 
                          background: ${isSelected ? 'var(--primary)' : 'transparent'};
                          border: ${isToday && !isSelected ? '1px solid var(--accent)' : 'none'};
                          color: ${isSelected ? '#fff' : 'var(--text)'};
                          position: relative;
                      ">
                         <span style="font-size: 14px;">${day}</span>
                         ${isMaxIncomeDay ? '<span style="position: absolute; top: -4px; right: -4px; font-size: 10px;">â¤ï¸</span>' : ''}
                         ${hasOrders ? `
                           <div style="display: flex; gap: 2px; margin-top: 2px;">
                              ${orderTypes.map(t => `<div style="width: 4px; height: 4px; border-radius: 50%; background: ${getOrderTypeColor(t)};"></div>`).join('')}
                           </div>
                         ` : ''}
                      </div>
                    `;
          }).join('');
        })()}
             </div>
          </div>
          
          <!-- å›¾ä¾‹ -->
          <div class="card" style="margin-top: 16px; padding: 16px;">
             <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--text);">å›¾ä¾‹</h3>
             <div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 13px;">
                <span style="display: flex; align-items: center; gap: 6px; color: #3b82f6;"><span style="width: 10px; height: 10px; border-radius: 50%; background: #3b82f6;"></span> æ­£å¸¸å•</span>
                <span style="display: flex; align-items: center; gap: 6px; color: #ec4899;"><span style="width: 10px; height: 10px; border-radius: 50%; background: #ec4899;"></span> ç¤¼ç‰©å•</span>
                <span style="display: flex; align-items: center; gap: 6px; color: #10b981;"><span style="width: 10px; height: 10px; border-radius: 50%; background: #10b981;"></span> æœˆå¡å•</span>
                <span style="display: flex; align-items: center; gap: 6px; color: #f59e0b;"><span style="width: 10px; height: 10px; border-radius: 50%; background: #f59e0b;"></span> é¢„å­˜å•</span>
                <span style="display: flex; align-items: center; gap: 6px; color: #ffd700;"><span style="width: 10px; height: 10px; border-radius: 50%; background: #ffd700;"></span> å¥–é‡‘</span>
             </div>
          </div>
          
          <!-- Selected Date Details -->
          ${selectedDetailDate ? `
             <div class="card">
                <h3 style="font-size: 16px; margin-bottom: 16px;">${month + 1}æœˆ${selectedDetailDate}æ—¥è®¢å•</h3>
                ${selectedOrders.length === 0 ? '<p class="text-muted text-center">è¯¥æ—¥æ— è®¢å•</p>' :
            selectedOrders.map(o => {
              const rec = cachedData.receptionists.find(x => x.id === o.receptionistId);
              const recName = rec ? rec.name : 'æœªçŸ¥';
              const typeName = getOrderTypeName(o.type);
              const typeColor = getOrderTypeColor(o.type);

              let recComm = 0, stuComm = 0, divComm = 0;
              if (o.type === 'monthly') {
                stuComm = 9.9;
              } else if (o.type === 'bonus') {
                recComm = o.amount;
              } else if (o.type === 'prepaid') {
                recComm = calculateCommission(o, rec || {});
                stuComm = calculateStudioIncomeForOrder(o);
              } else if (['normal', 'gift'].includes(o.type)) {
                recComm = calculateCommission(o, rec || {});
                stuComm = calculateStudioIncomeForOrder(o);
                divComm = (o.amount || 0) - recComm - stuComm;
              } else if (o.type === 'deduct_prepaid') {
                divComm = o.amount;
              }

              return `
                       <div style="border-left: 4px solid ${typeColor}; background: var(--bg-light); border-radius: 8px; overflow: hidden; margin-bottom: 12px;">
                          <div style="padding: 8px 12px; background: ${typeColor}15; display: flex; justify-content: space-between; align-items: center;">
                             <span style="font-weight: bold; color: ${typeColor};">${typeName}</span>
                          </div>
                           <div style="padding: 12px; color: ${typeColor};">
                              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                 <span style="font-size: 14px; color: var(--text-muted);">
                                    ${r.id === 'all' ? `æ¥å¾…ï¼š<span style="color: var(--text);">${recName}</span> | ` : ''}
                                    è€æ¿ï¼š<span style="color: var(--text);">${o.bossName.replace(/ #\d+$/, '')}</span> | 
                                    å åœå¸ˆï¼š<span style="color: var(--text);">${o.divinerId || 'æ— '}</span>
                                 </span>
                                 <button class="btn-text" style="color: var(--danger); font-size: 12px;" onclick="deleteOrder(${o.id}, event)">âœ– åˆ é™¤</button>
                              </div>
                              
                              ${o.type !== 'monthly' ? `<div style="margin-bottom: 4px; font-weight: bold;">ä»·æ ¼ï¼šÂ¥${o.amount}</div>` : ''}
                              
                              ${o.type !== 'monthly' && o.type !== 'bonus' ? `
                                 <div style="font-size: 12px; color: var(--text-muted); display: flex; flex-direction: column; gap: 4px; align-items: flex-start;">
                                    <div>æ¥å¾…ææˆï¼šÂ¥${recComm.toFixed(2)}</div>
                                    <div>å åœå¸ˆææˆï¼šÂ¥${divComm.toFixed(2)}</div>
                                    <div>å·¥ä½œå®¤ææˆï¼šÂ¥${stuComm.toFixed(2)}</div>
                                 </div>
                              ` : ''}
                           </div>
                        </div>
                      `;
            }).join('')
          }
             </div>
          ` : ''}
        `;
      document.getElementById('pageContent').innerHTML = html;
    }

    function getOrdersForDate(day, orders, year, month) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      return orders.filter(o => o.date === dateStr);
    }

    function prevDetailMonth() {
      currentDetailDate = new Date(currentDetailDate.getFullYear(), currentDetailDate.getMonth() - 1, 1);
      selectedDetailDate = null;
      renderMonthlyFlowDetail();
    }

    function nextDetailMonth() {
      currentDetailDate = new Date(currentDetailDate.getFullYear(), currentDetailDate.getMonth() + 1, 1);
      selectedDetailDate = null;
      renderMonthlyFlowDetail();
    }

    function selectDetailDate(day) {
      selectedDetailDate = (selectedDetailDate === day) ? null : day;
      renderMonthlyFlowDetail();
    }

    // ç®¡ç†æ¥å¾…è§†å›¾
    function renderManageReceptionists() {
      const receptionists = cachedData.receptionists.filter(r => r.role === 'receptionist' && !r.isDeleted);
      const interns = cachedData.receptionists.filter(r => r.role === 'receptionist' && r.isIntern && !r.isDeleted);
      let html = renderHeader() + `
      <div class="card" >
          <h2 style="font-size: 18px; margin-bottom: 24px;">ğŸ” æŸ¥æ‰¾ä¿¡æ¯ä¸è¡¥å½•ä¸å®ä¹ ç®¡ç†</h2>
          
          <div style="margin-bottom: 20px;">
             <button class="btn btn-secondary btn-full" onclick="setView('bossList')">ğŸ“– æŸ¥çœ‹è€æ¿åå•</button>
          </div>

          <!--æœç´¢å•å­ä¿¡æ¯ -->
          <div style="margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px dashed var(--border);">
            <div style="display: flex; gap: 8px; align-items: center;">
              <input type="text" id="manageOrderSearchInput" class="form-input" placeholder="æœç´¢å•å­å…³é”®è¯ (å¦‚: è€æ¿å/é—®é¢˜/å åœå¸ˆ)" style="margin-bottom: 0;">
              <button id="manageOrderSearchBtn" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 0 8px;">ğŸ±</button>
            </div>
            <div id="manageOrderSearchResult" class="hidden" style="margin-top: 12px; background: var(--bg-light); padding: 12px; border-radius: 8px;">
              <!-- æœç´¢ç»“æœ -->
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" style="font-weight: bold; color: var(--text);">è´¦å·è®¢å•ç®¡ç†-é€‰æ‹©æ¥å¾…</label>
            <select id="manageReceptionist" class="form-select" onchange="onManageReceptionistChange()">
              <option value="">è¯·é€‰æ‹©æ¥å¾…</option>
              ${receptionists.map(r => `<option value="${r.id}">${r.emoji} ${r.name}</option>`).join('')}
            </select>
          </div>
          <div id="manageActions" class="hidden flex flex-col gap-3 mt-4" style="margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px dashed var(--border);">
            <button class="btn btn-primary btn-full" onclick="showAddOrderModal()">ğŸ“ è¡¥å½•è®¢å•</button>
            <button class="btn btn-danger btn-full" onclick="showDeleteModal()">ğŸ—‘ï¸ åˆ é™¤è´¦å·</button>
          </div>
          
          <!-- å®ä¹ ç®¡ç†éƒ¨åˆ† -->
          <div style="margin-top: 20px;">
            <h3 style="font-size: 16px; margin-bottom: 12px;">ğŸ“ å®ä¹ ç®¡ç†</h3>
            <p class="text-muted text-sm mb-3">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æŸ¥çœ‹æ‰€æœ‰æ¥å¾…å¹¶ç®¡ç†å®ä¹ çŠ¶æ€</p>
            <button class="btn btn-secondary btn-full" onclick="showInternModal()">ğŸ“‹ ç®¡ç†å…¨éƒ¨æ¥å¾…å®ä¹ çŠ¶æ€</button>
            ${interns.length > 0 ? `
              <div style="margin-top: 16px;">
                <p class="text-muted text-sm mb-2">å½“å‰å®ä¹ ä¸­ (${interns.length}äºº)ï¼šå‹¾é€‰å¯é€šè¿‡å®ä¹ </p>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  ${interns.map(r => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--bg-light); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">${r.emoji}</span>
                        <span style="font-weight: 500;">${r.name}</span>
                        <span class="text-xs" style="color: var(--warning);">å®ä¹ ä¸­</span>
                      </div>
                      <button class="settle-checkbox" onclick="passIntern('${r.id}')" style="width: 28px; height: 28px;">âœ“</button>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div >
        
        <!-- å®ä¹ ç®¡ç†æ¨¡æ€æ¡† -->
        <div id="internModal" class="modal-overlay hidden">
          <div class="card modal-content" style="max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0;">ğŸ“ å…¨éƒ¨æ¥å¾…å®ä¹ çŠ¶æ€</h3>
              <button onclick="closeInternModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-muted);">âœ•</button>
            </div>
            <p class="text-muted text-sm mb-4">ç‚¹å‡»æ¥å¾…å¯åˆ‡æ¢å®ä¹ çŠ¶æ€ | é»„è‰²æ ‡ç­¾=å®ä¹ ä¸­</p>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              ${receptionists.map(r => {
        const createdAt = new Date(r.createdAt);
        const now = new Date();
        const daysSinceRegistration = Math.floor((now - createdAt) / (1000 * 60 * 60 * 24));
        return `
                  <div onclick="toggleInternStatus('${r.id}')" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--bg-light); border-radius: 8px; cursor: pointer; border: 1px solid ${r.isIntern ? 'var(--warning)' : 'transparent'};">
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <span style="font-size: 20px;">${r.emoji}</span>
                      <div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                          <span style="font-weight: 500;">${r.name}</span>
                          ${r.isIntern ? '<span class="text-xs" style="color: var(--warning); background: rgba(245,158,11,0.15); padding: 2px 6px; border-radius: 4px;">å®ä¹ ä¸­</span>' : '<span class="text-xs" style="color: var(--success); background: rgba(16,185,129,0.15); padding: 2px 6px; border-radius: 4px;">æ­£å¼</span>'}
                        </div>
                        <p class="text-xs text-muted" style="margin-top: 4px;">æ³¨å†Œ ${daysSinceRegistration} å¤©</p>
                      </div>
                    </div>
                    <span style="font-size: 12px; color: var(--text-muted);">ç‚¹å‡»åˆ‡æ¢ â†’</span>
                  </div>
                `;
      }).join('')}
            </div>
          </div>
        </div>
        <div id="addOrderModal" class="modal-overlay hidden">
          <div class="card modal-content">
            <h3 style="margin-bottom: 16px;">ğŸ“ è¡¥å½•è®¢å•</h3>
            <form id="addOrderForm" onsubmit="handleAddOrder(event)">
              <div class="form-group"><label class="form-label">æ—¥æœŸ</label><input type="date" id="addOrderDate" class="form-input" value="${getToday()}" required></div>
              <div class="form-group"><label class="form-label">è€æ¿åç§°</label><input type="text" id="addOrderBoss" class="form-input" required></div>
              <div class="form-group"><label class="form-label">å•å­ç±»å‹</label>
                <select id="addOrderType" class="form-select" onchange="onAddOrderTypeChange()">
                  <option value="normal">æ­£å¸¸å•</option><option value="gift">ç¤¼ç‰©å•</option>
                  <option value="monthly">æœˆå¡å•</option><option value="prepaid">é¢„å­˜å•</option>
                </select>
              </div>
              <div class="form-group" id="addOrderAmountGroup"><label class="form-label">é‡‘é¢</label><input type="number" id="addOrderAmount" class="form-input" step="0.01"></div>
              <div class="form-group hidden" id="addOrderCountGroup"><label class="form-label">æ•°é‡ï¼ˆä¸ªï¼‰</label><input type="number" id="addOrderCount" class="form-input" min="1" value="1"></div>
              <div class="flex gap-3">
                <button type="button" class="btn btn-secondary flex-1" onclick="closeAddOrderModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary flex-1">ç¡®è®¤è¡¥å½•</button>
              </div>
            </form>
          </div>
        </div>
        <div id="deleteModal" class="modal-overlay hidden">
          <div class="card modal-content">
            <h3 style="margin-bottom: 16px; color: var(--danger);">âš ï¸ åˆ é™¤è´¦å·</h3>
            <p class="text-muted mb-5">æ˜¯å¦ä¿ç•™è¯¥æ¥å¾…çš„è®¢å•è®°å½•ï¼Ÿ</p>
            <div class="flex flex-col gap-3">
              <button class="btn btn-secondary btn-full" onclick="deleteAccount(true)">ä¿ç•™è®¢å•ï¼Œä»…åˆ é™¤è´¦å·</button>
              <button class="btn btn-danger btn-full" onclick="deleteAccount(false)">å…¨éƒ¨åˆ é™¤</button>
              <button class="btn btn-secondary btn-full" onclick="closeDeleteModal()">å–æ¶ˆ</button>
            </div>
          </div>
        </div>
    `;
      document.getElementById('pageContent').innerHTML = html;
      document.getElementById('manageOrderSearchBtn').addEventListener('click', searchManageOrders);
      document.getElementById('manageOrderSearchInput').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') searchManageOrders();
      });

      function searchManageOrders() {
        const input = document.getElementById('manageOrderSearchInput').value.trim();
        const container = document.getElementById('manageOrderSearchResult');

        if (!input) {
          container.classList.add('hidden');
          return;
        }

        const orders = cachedData.orders;
        const receptionists = cachedData.receptionists;
        let resultsHtml = '';
        let hasMatch = false;

        // 1. æ£€æŸ¥æ˜¯å¦åŒ¹é…è€æ¿åå­—
        const allBossNames = [...new Set(orders.map(o => o.bossName))];
        if (allBossNames.includes(input)) {
          hasMatch = true;
          const bossOrders = orders.filter(o => o.bossName === input);
          const normalCount = bossOrders.filter(o => o.type === 'normal').length;
          const monthlyCount = bossOrders.filter(o => o.type === 'monthly').length;
          const balance = getBossBalanceSync(input);

          const totalConsumption = bossOrders
            .reduce((sum, o) => {
              if (o.type === 'monthly') return sum + 9.9;
              if (['normal', 'gift', 'deduct_prepaid'].includes(o.type)) return sum + (o.amount || 0);
              return sum;
            }, 0);

          resultsHtml += `
      <div onclick = "setView('bossDetail', { name: '${input}' })" style = "background: transparent; border: 1px solid var(--border); padding: 16px; border-radius: 12px; cursor: pointer; transition: transform 0.2s; margin-bottom: 12px;" >
               <div style="margin-bottom: 12px;">
                 <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 8px; color: var(--text);">ğŸ¯ è€æ¿ï¼š${input}</h3>
                 <p style="font-size: 14px; color: var(--text-muted);">å…±æ¶ˆè´¹ï¼šæ­£å¸¸å• ${normalCount} å•ï¼Œæœˆå¡ ${monthlyCount} å•</p>
                 <p style="font-size: 14px; color: var(--text-muted);">ä½™é¢ï¼š<span style="font-weight: bold; color: var(--accent); font-size: 16px;">Â¥${balance.toFixed(0)}</span></p>
                 <p style="font-size: 14px; color: var(--text-muted);">ç´¯è®¡æ¶ˆè´¹ï¼šÂ¥${totalConsumption.toFixed(0)} <span style="font-size: 12px; opacity: 0.8;">ï¼ˆæ­£å¸¸å•ï¼Œæœˆå¡ï¼Œé¢„å­˜ï¼Œç¤¼ç‰©ï¼‰</span></p>
               </div>
               <div style="text-align: right;">
                  <span class="btn btn-sm btn-primary" style="background: var(--primary); color: #fff; padding: 6px 16px; border-radius: 20px; font-size: 12px;">æŸ¥çœ‹è¯¦ç»†è®°å½• ></span>
               </div>
             </div >
      `;
        }

        // 2. æ£€æŸ¥æ˜¯å¦åŒ¹é…æ¥å¾…åå­—
        const matchedReceptionist = receptionists.find(r => r.name === input);
        if (matchedReceptionist) {
          hasMatch = true;
          const rOrders = orders.filter(o => o.receptionistId === matchedReceptionist.id);

          // åˆ†ç±»ç»Ÿè®¡è®¢å•
          const normalCount = rOrders.filter(o => o.type === 'normal').length;
          const giftCount = rOrders.filter(o => o.type === 'gift').length;
          const monthlyCount = rOrders.filter(o => o.type === 'monthly').length;
          const prepaidCount = rOrders.filter(o => o.type === 'prepaid').length;
          const bonusCount = rOrders.filter(o => o.type === 'bonus').length;

          // å®é™…è®¢å•æ•°ï¼ˆä¸å«å¥–åŠ±ï¼‰
          const actualOrderCount = normalCount + giftCount + monthlyCount + prepaidCount;

          // è®¡ç®—ç´¯è®¡æµæ°´ï¼ˆä¸å«å¥–åŠ±å’Œæœˆå¡å•ï¼‰
          const totalAmount = rOrders.reduce((sum, o) => {
            if (o.type === 'monthly') return sum + 9.9;
            if (['normal', 'gift', 'deduct_prepaid', 'prepaid'].includes(o.type)) return sum + (o.amount || 0);
            return sum;
          }, 0);

          resultsHtml += `
      <div onclick = "setView('receptionistDetail', { id: '${matchedReceptionist.id}' })" style = "background: transparent; border: 1px solid var(--border); padding: 16px; border-radius: 12px; cursor: pointer; transition: transform 0.2s; margin-bottom: 12px;" >
               <div style="margin-bottom: 12px;">
                 <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 8px; color: var(--text);">ğŸ‘¤ æ¥å¾…ï¼š${matchedReceptionist.name}</h3>
                 <p style="font-size: 14px; color: var(--text-muted); margin-bottom: 4px;">ç´¯è®¡æ¥å•ï¼š<span style="font-weight: bold; color: var(--text);">${actualOrderCount}</span> å•</p>
                 <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">
                   æ­£å¸¸å• ${normalCount} | ç¤¼ç‰©å• ${giftCount} | æœˆå¡å• ${monthlyCount} | é¢„å­˜å• ${prepaidCount}
                 </p>
                 <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                   ğŸ† å¥–åŠ±è®°å½• ${bonusCount} æ¡ï¼ˆä¸è®¡å…¥å•æ•°ï¼‰
                 </p>
                 <p style="font-size: 14px; color: var(--text-muted);">ç´¯è®¡æµæ°´ï¼š<span style="font-weight: bold; color: var(--accent); font-size: 16px;">Â¥${totalAmount.toFixed(0)}</span></p>
               </div>
               <div style="text-align: right;">
                  <span class="btn btn-sm btn-primary" style="background: var(--primary); color: #fff; padding: 6px 16px; border-radius: 20px; font-size: 12px;">æŸ¥çœ‹æ¥å¾…è®°å½• ></span>
               </div>
             </div >
      `;
        }

        // 3. æ£€æŸ¥æ˜¯å¦åŒ¹é…å åœå¸ˆåå­—
        const allDiviners = [...new Set(orders.map(o => o.divinerId).filter(d => d && d !== 'æ— '))];
        if (allDiviners.includes(input)) {
          hasMatch = true;
          const dOrders = orders.filter(o => o.divinerId === input);

          const totalIncome = dOrders.reduce((sum, o) => {
            if (o.type === 'monthly' || o.type === 'prepaid' || o.type === 'bonus') return sum;

            const amount = o.amount || 0;
            if (o.type === 'deduct_prepaid') {
              return sum + amount;
            }

            const rec = receptionists.find(r => r.id === o.receptionistId) || { commissionRate: 5 };
            const recComm = calculateCommission(o, rec);
            const stuComm = calculateStudioIncomeForOrder(o);
            const divComm = amount - recComm - stuComm;
            return sum + divComm;
          }, 0);

          resultsHtml += `
      <div onclick = "setView('divinerDetail', { name: '${input}' })" style = "background: transparent; border: 1px solid var(--border); padding: 16px; border-radius: 12px; cursor: pointer; transition: transform 0.2s; margin-bottom: 12px;" >
               <div style="margin-bottom: 12px;">
                 <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 8px; color: var(--text);">ğŸ”® å åœå¸ˆï¼š${input}</h3>
                 <p style="font-size: 14px; color: var(--text-muted);">ç´¯è®¡å åœï¼š${dOrders.length} å•</p>
                 <p style="font-size: 14px; color: var(--text-muted);">æ€»å…±æ”¶å…¥ï¼š<span style="font-weight: bold; color: var(--accent); font-size: 16px;">Â¥${totalIncome.toFixed(2)}</span></p>
               </div>
               <div style="text-align: right;">
                  <span class="btn btn-sm btn-primary" style="background: var(--primary); color: #fff; padding: 6px 16px; border-radius: 20px; font-size: 12px;">æŸ¥çœ‹å åœè®°å½• ></span>
               </div>
             </div >
      `;
        }

        // å¦‚æœæœ‰åŒ¹é…çš„åç‰‡ï¼Œæ˜¾ç¤ºå®ƒä»¬
        if (hasMatch) {
          container.innerHTML = resultsHtml;
          container.classList.remove('hidden');
          return;
        }

        // 4. å¦åˆ™æ‰§è¡ŒåŸæ¥çš„æ¨¡ç³Šæœç´¢
        const inputLower = input.toLowerCase();

        const matches = orders.filter(o => {
          const typeName = getOrderTypeName(o.type);
          const content = `${o.bossName} ${typeName} ${o.divinerId || ''} ${o.questionContent || ''} ${o.amount} `.toLowerCase();
          return content.includes(inputLower);
        });

        if (matches.length === 0) {
          container.innerHTML = '<p class="text-muted text-center text-sm">æœªæ‰¾åˆ°ç›¸å…³è®¢å•</p>';
        } else {
          // æŒ‰æ—¶é—´å€’åº
          matches.sort((a, b) => new Date(b.date) - new Date(a.date));

          container.innerHTML = matches.slice(0, 10).map(o => {
            const r = receptionists.find(rec => rec.id === o.receptionistId);
            const rName = r ? r.name : 'æœªçŸ¥';
            const typeColor = getOrderTypeColor(o.type);
            const typeName = getOrderTypeName(o.type);

            return `
      <div style = "background: var(--bg-card); border: 1px solid var(--border); padding: 8px; border-radius: 6px; margin-bottom: 8px;" >
                  <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">
                     <span style="font-weight: bold;">è€æ¿ï¼š${o.bossName}</span>
                     <div style="display: flex; align-items: center; gap: 8px;">
                       <span style="color: ${typeColor}; background: ${typeColor}15; padding: 1px 4px; border-radius: 4px;">${typeName}</span>
                       <button onclick="deleteSearchOrder(${o.id})" style="background: var(--danger); color: white; border: none; border-radius: 4px; padding: 2px 8px; font-size: 11px; cursor: pointer;">åˆ é™¤</button>
                     </div>
                  </div>
                  <div style="font-size: 12px; color: var(--text-muted); display: flex; flex-direction: column; gap: 2px;">
                     <p>æ—¥æœŸ: ${formatDate(o.date)} | æ¥å¾…: ${rName}</p>
                     ${o.type !== 'monthly' ? `<p>é‡‘é¢: Â¥${o.amount}</p>` : ''}
                     ${o.divinerId && o.divinerId !== 'æ— ' ? `<p>å åœå¸ˆ: ${o.divinerId}</p>` : ''}
                     ${o.questionContent ? `<p>é—®é¢˜: ${o.questionContent}</p>` : ''}
                  </div>
                </div >
      `;
          }).join('');

          if (matches.length > 10) {
            container.innerHTML += `< p class="text-center text-xs text-muted mt-2" > ä»…æ˜¾ç¤ºæœ€è¿‘ 10 æ¡åŒ¹é…ç»“æœ</p > `;
          }
        }

        container.classList.remove('hidden');
      }
    }

    async function handleAddOrder(e) {
      e.preventDefault();
      const rid = document.getElementById('manageReceptionist').value;
      const type = document.getElementById('addOrderType').value;
      const date = document.getElementById('addOrderDate').value;
      const bossName = document.getElementById('addOrderBoss').value;

      if (!rid) {
        alert('è¯·å…ˆé€‰æ‹©æ¥å¾…');
        return;
      }

      try {
        if (type === 'monthly') {
          // æœˆå¡å•ï¼šæ ¹æ®æ•°é‡æ‰¹é‡åˆ›å»º
          const count = parseInt(document.getElementById('addOrderCount').value) || 1;
          for (let i = 0; i < count; i++) {
            await DataStore.saveOrder({
              receptionistId: rid,
              date: date,
              bossName: bossName + (count > 1 ? ` #${i + 1}` : ''),
              type: 'monthly',
              divinerId: 'æ— ',
              amount: 0,
              approved: true
            });
          }
          await refreshData();
          closeAddOrderModal();
          alert('è¡¥å½•æˆåŠŸï¼å…±æ·»åŠ  ' + count + ' ä¸ªæœˆå¡å•');
        } else {
          // å…¶ä»–ç±»å‹ï¼šå•ä¸ªåˆ›å»º
          await DataStore.saveOrder({
            receptionistId: rid,
            date: date,
            bossName: bossName,
            type: type,
            divinerId: type === 'prepaid' ? 'æ— ' : '',
            amount: parseFloat(document.getElementById('addOrderAmount').value) || 0,
            approved: true
          });
          await refreshData();
          closeAddOrderModal();
          alert('è¡¥å½•æˆåŠŸï¼');
        }
      } catch (err) {
        console.error('è¡¥å½•è®¢å•å¤±è´¥:', err);
        alert('è¡¥å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
      }
    }

    function onAddOrderTypeChange() {
      const type = document.getElementById('addOrderType').value;
      const amountGroup = document.getElementById('addOrderAmountGroup');
      const countGroup = document.getElementById('addOrderCountGroup');
      if (type === 'monthly') {
        amountGroup.classList.add('hidden');
        countGroup.classList.remove('hidden');
      } else {
        amountGroup.classList.remove('hidden');
        countGroup.classList.add('hidden');
      }
    }

    function onManageReceptionistChange() {
      const v = document.getElementById('manageReceptionist').value;
      document.getElementById('manageActions').classList.toggle('hidden', !v);
    }

    function showInternModal() {
      document.getElementById('internModal').classList.remove('hidden');
    }

    function closeInternModal() {
      document.getElementById('internModal').classList.add('hidden');
    }

    async function toggleInternStatus(rid) {
      const r = cachedData.receptionists.find(x => x.id === rid);
      if (!r) return;

      const newStatus = !r.isIntern;
      const statusText = newStatus ? 'å®ä¹ ä¸­' : 'æ­£å¼';

      if (!confirm(`ç¡®å®šå°† ${r.name} è®¾ç½®ä¸ºã€Œ${statusText}ã€å—ï¼Ÿ`)) {
        return;
      }

      await DataStore.updateReceptionist(rid, { isIntern: newStatus });
      await refreshData();
      closeInternModal();
      renderManageReceptionists();
    }
    function showAddOrderModal() { document.getElementById('addOrderModal').classList.remove('hidden'); }
    function closeAddOrderModal() { document.getElementById('addOrderModal').classList.add('hidden'); }
    function showDeleteModal() { document.getElementById('deleteModal').classList.remove('hidden'); }
    function closeDeleteModal() { document.getElementById('deleteModal').classList.add('hidden'); }

    async function deleteSearchOrder(orderId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®¢å•å—ï¼Ÿ')) return;

      await DataStore.deleteOrder(orderId);
      await refreshData();

      // é‡æ–°è§¦å‘æœç´¢ä»¥åˆ·æ–°ç»“æœ
      const searchInput = document.getElementById('manageOrderSearchInput');
      if (searchInput && searchInput.value.trim()) {
        document.getElementById('manageOrderSearchBtn').click();
      }
    }
    async function deleteAccount(keepOrders) {
      const rid = document.getElementById('manageReceptionist').value;
      if (!rid) {
        alert('è¯·å…ˆé€‰æ‹©æ¥å¾…');
        return;
      }

      const success = await DataStore.deleteReceptionist(rid, keepOrders);
      if (success) {
        closeDeleteModal();
        await refreshData();
        renderManageReceptionists();
      } else {
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // å®ä¹ ç®¡ç†è§†å›¾
    function renderInternManagement() {
      const interns = cachedData.receptionists.filter(r => r.role === 'receptionist' && r.isIntern && !r.isDeleted);
      let html = renderHeader() + `
      <div class="card" >
          <h2 style="font-size: 18px; margin-bottom: 16px;">ğŸ“ æ¥å¾…ç®¡ç†ï¼ˆå®ä¹ ï¼‰</h2>
          <p class="text-muted text-sm mb-4">å‹¾é€‰åè¡¨ç¤ºé€šè¿‡å®ä¹ ï¼Œåº•è–ªä» 20 å…ƒ/å‘¨ â†’ 40 å…ƒ/å‘¨</p>
          ${interns.length === 0 ? '<p class="text-muted text-center" style="padding: 20px;">æš‚æ— å®ä¹ ä¸­çš„æ¥å¾…</p>' : interns.map(r => `
            <div class="flex justify-between items-center" style="padding: 16px; background: var(--bg-light); border-radius: 12px; margin-bottom: 12px;">
              <div class="flex items-center gap-3">
                <span style="font-size: 24px;">${r.emoji}</span>
                <span>${r.name}</span>
              </div>
              <button class="settle-checkbox" onclick="passIntern('${r.id}')">âœ“</button>
            </div>
          `).join('')
        }
        </div >
      `;
      document.getElementById('pageContent').innerHTML = html;
    }

    async function passIntern(rid) {
      await DataStore.updateReceptionist(rid, { isIntern: false });
      await refreshData();
      renderManageReceptionists();
    }

    // æƒ©ç½šç³»ç»Ÿè§†å›¾
    function renderPenalty() {
      const receptionists = cachedData.receptionists.filter(r => r.role === 'receptionist' && !r.isDeleted);
      const allReceptionists = cachedData.receptionists.filter(r => r.role === 'receptionist');

      // è·å–æœ¬æœˆæ‰€æœ‰ç½šæ¬¾è®°å½• - ä» penalties è¡¨
      const monthStart = getMonthStart();
      let monthlyPenalties = cachedData.penalties
        .filter(p => new Date(p.date) >= monthStart)
        .map(p => {
          const r = allReceptionists.find(rec => rec.id === p.receptionistId);
          return {
            ...p,
            receptionistName: r?.name || 'æœªçŸ¥',
            receptionistEmoji: r?.emoji || 'ğŸ‘¤'
          };
        });
      // æŒ‰æ—¥æœŸæ’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢
      monthlyPenalties.sort((a, b) => new Date(b.date) - new Date(a.date));

      let html = renderHeader() + `
      <div class="card mb-4" >
          <h2 style="font-size: 18px; margin-bottom: 16px;">âš ï¸ æƒ©ç½šç³»ç»Ÿ</h2>
          <div id="penaltySuccess" class="error-message hidden" style="background: rgba(239,68,68,0.2);">æƒ©ç½šå·²è®°å½•</div>
          <form id="penaltyForm">
            <div class="form-group">
              <label class="form-label">ç½šæ¬¾äºº</label>
              <select id="penaltyReceptionist" class="form-select" required>
                <option value="">è¯·é€‰æ‹©æ¥å¾…</option>
                ${receptionists.map(r => '<option value="' + r.id + '">' + r.emoji + ' ' + r.name + '</option>').join('')}
              </select>
            </div>
            <div class="form-group"><label class="form-label">ç½šæ¬¾åŸå› </label><input type="text" id="penaltyReason" class="form-input" placeholder="è¯·è¾“å…¥ç½šæ¬¾åŸå› " required></div>
            <div class="form-group"><label class="form-label">ç½šæ¬¾æ—¶é—´</label><input type="date" id="penaltyDate" class="form-input" value="${getToday()}" required></div>
            <div class="form-group"><label class="form-label">ç½šæ¬¾é‡‘é¢</label><input type="number" id="penaltyAmount" class="form-input" placeholder="è¯·è¾“å…¥é‡‘é¢" step="0.01" required></div>
            <button type="submit" class="btn btn-danger btn-full">ç¡®è®¤ç½šæ¬¾</button>
          </form>
        </div >

      <div class="card">
        <h3 style="font-size: 16px; margin-bottom: 16px;">ğŸ“‹ æœ¬æœˆç½šæ¬¾è®°å½•</h3>
        ${monthlyPenalties.length === 0 ? '<p class="text-muted text-center" style="padding: 20px;">æœ¬æœˆæš‚æ— ç½šæ¬¾è®°å½•</p>' :
          '<div style="margin-bottom: 12px; padding: 12px; background: rgba(239,68,68,0.1); border-radius: 10px; text-align: center;"><p class="text-muted text-sm">æœ¬æœˆå…± ' + monthlyPenalties.length + ' æ¡ç½šæ¬¾</p><p style="font-size: 24px; font-weight: 700; color: var(--danger);">Â¥' + monthlyPenalties.reduce((sum, p) => sum + p.amount, 0).toFixed(2) + '</p></div>' +
          monthlyPenalties.map(p => `
              <div style="display: flex; align-items: center; padding: 12px; background: var(--bg-light); border-radius: 10px; margin-bottom: 8px; border-left: 4px solid var(--danger);">
                <div style="flex: 1;">
                  <p style="font-weight: 600; margin-bottom: 4px;">${p.receptionistEmoji} ${p.receptionistName}</p>
                  <p class="text-sm text-muted" style="margin-bottom: 4px;">åŸå› ï¼š${p.reason}</p>
                  <p style="color: var(--danger); font-weight: 600; margin-bottom: 4px;">-Â¥${p.amount}</p>
                  <p class="text-xs text-muted">${p.date}</p>
                </div>
                <button class="btn btn-secondary" style="padding: 8px; min-width: auto;" onclick="deletePenalty('${p.receptionistId}', ${p.id})">ğŸ—‘ï¸</button>
              </div>
            `).join('')
        }
      </div>
    `;
      document.getElementById('pageContent').innerHTML = html;
      document.getElementById('penaltyForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const rid = document.getElementById('penaltyReceptionist').value;
        const penalty = {
          receptionistId: rid,
          reason: document.getElementById('penaltyReason').value,
          date: document.getElementById('penaltyDate').value,
          amount: parseFloat(document.getElementById('penaltyAmount').value)
        };

        await DataStore.savePenalty(penalty);

        document.getElementById('penaltySuccess').classList.remove('hidden');
        setTimeout(async () => {
          document.getElementById('penaltySuccess').classList.add('hidden');
          document.getElementById('penaltyForm').reset();
          await refreshData();
          renderPenalty();
        }, 1000);
      });
    }

    async function deletePenalty(receptionistId, penaltyId) {
      if (confirm('ç¡®å®šåˆ é™¤æ­¤ç½šæ¬¾è®°å½•ï¼Ÿ')) {
        await DataStore.deletePenalty(penaltyId);
        await refreshData();
        renderPenalty();
      }
    }

    function toggleDailyDetail(rid) {
      const el = document.getElementById(`dailyDetail-${rid}`);
      if (el) {
        el.classList.toggle('hidden');
        // é˜»æ­¢å†’æ³¡é˜²æ­¢è§¦å‘å…¶ä»–ç‚¹å‡»äº‹ä»¶ï¼ˆè™½ç„¶è¿™é‡Œå¯èƒ½ä¸éœ€è¦ï¼Œä½†ä¸ºäº†ä¿é™©ï¼‰
        window.event && window.event.stopPropagation();
      }
    }

    // å…¬å‘Šç³»ç»Ÿè§†å›¾
    function renderAnnouncement() {
      const announcements = cachedData.announcements;
      let html = renderHeader() + `
      <div class="card" >
          <h2 style="font-size: 18px; margin-bottom: 16px;">ğŸ“¢ é€šçŸ¥å…¬å‘Šç³»ç»Ÿ</h2>
          <div id="announcementSuccess" class="success-message hidden">âœ¨ å…¬å‘Šå·²å‘å¸ƒï¼</div>
          <form id="announcementForm" class="mb-5">
            <div class="form-group"><label class="form-label">å…¬å‘Šå†…å®¹</label><textarea id="announcementContent" class="form-input" style="min-height: 100px; resize: vertical;" placeholder="è¯·è¾“å…¥å…¬å‘Šå†…å®¹" required></textarea></div>
            <button type="submit" class="btn btn-primary btn-full">å‘å¸ƒå…¬å‘Š</button>
          </form>
          <h3 style="font-size: 16px; margin-bottom: 12px;">å†å²å…¬å‘Š</h3>
          ${announcements.length === 0 ? '<p class="text-muted text-sm">æš‚æ— å…¬å‘Š</p>' : announcements.slice().reverse().map(a => `
            <div style="padding: 12px; background: var(--bg-light); border-radius: 10px; margin-bottom: 8px; position: relative;">
              <p style="font-size: 14px; line-height: 1.6; padding-right: 30px;">${a.content}</p>
              <p class="text-xs text-muted mt-2">${new Date(a.createdAt).toLocaleString()}</p>
              <button class="delete-cat-btn" style="top: 8px; right: 8px;" onclick="deleteAnnouncement(${a.id})">${createDeleteCatSVG()}</button>
            </div>
          `).join('')
        }
        </div >
      `;
      document.getElementById('pageContent').innerHTML = html;
      document.getElementById('announcementForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const content = document.getElementById('announcementContent').value.trim();
        if (!content) return;

        await DataStore.saveAnnouncement(content);

        document.getElementById('announcementSuccess').classList.remove('hidden');
        setTimeout(async () => {
          document.getElementById('announcementSuccess').classList.add('hidden');
          document.getElementById('announcementForm').reset();
          await refreshData();
          renderAnnouncement();
        }, 1500);
      });
    }

    async function deleteAnnouncement(id) {
      if (confirm('ç¡®å®šåˆ é™¤æ­¤å…¬å‘Šï¼Ÿ')) {
        await DataStore.deleteAnnouncement(id);
        await refreshData();
        renderAnnouncement();
      }
    }
    // æ¥å¾…è¯¦ç»†è®°å½•è§†å›¾
    function renderReceptionistDetail(data) {
      if (!data || !data.id) {
        setView('manageReceptionists');
        return;
      }

      const receptionists = cachedData.receptionists;
      const targetId = String(data.id);
      const r = receptionists.find(rec => String(rec.id) === targetId) || { name: 'æœªçŸ¥', emoji: 'ğŸ‘¤' };
      const orders = cachedData.orders.filter(o => String(o.receptionistId) === targetId);

      // æŒ‰æ—¶é—´å€’åº
      orders.sort((a, b) => new Date(b.date) - new Date(a.date));

      const totalAmount = orders.reduce((sum, o) => {
        // åªç»Ÿè®¡æœ‰é‡‘é¢çš„å•å­ (æ­£å¸¸ã€ç¤¼ç‰©ã€é¢„å­˜)ï¼Œæœˆå¡æŒ‰ 9.9
        if (o.type === 'monthly') return sum + 9.9;
        if (['normal', 'gift', 'deduct_prepaid', 'prepaid'].includes(o.type)) return sum + (o.amount || 0);
        return sum;
      }, 0);

      let html = renderHeader() + `
      <div class="card" >
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 24px;">
             <button class="btn-text" onclick="setView('manageReceptionists')">â† è¿”å›</button>
             <h2 style="font-size: 18px; margin: 0;">${r.emoji} ${r.name} çš„æ¥å¾…è®°å½•</h2>
          </div>

           <div style="background: transparent; border: 1px solid var(--border); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
               <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                  <div>
                    <p class="text-muted">ç´¯è®¡æ¥å•</p>
                    <p style="font-size: 20px; font-weight: bold; color: var(--text);">${orders.length} å•</p>
                  </div>
                  <div>
                    <p class="text-muted">ç´¯è®¡æµæ°´</p>
                    <p style="font-size: 20px; font-weight: bold; color: var(--accent);">Â¥${totalAmount.toFixed(0)}</p>
                  </div>
               </div>
           </div>
          
          <div style="display: flex; flex-direction: column; gap: 12px;">
            ${orders.length === 0 ? '<p class="text-muted text-center">æš‚æ— è®°å½•</p>' :
          orders.map(o => {
            const typeName = getOrderTypeName(o.type);
            const typeColor = getOrderTypeColor(o.type);

            return `
                   <div style="background: var(--bg-light); padding: 12px; border-radius: 8px; border-left: 4px solid ${typeColor}; font-size: 14px; line-height: 1.6;">
                      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                        <p style="margin: 0;"><span style="font-weight: bold;">æ—¥æœŸï¼š</span>${formatDate(o.date)}</p>
                        <button onclick="deleteReceptionistOrder(${o.id}, '${targetId}')" style="background: var(--danger); color: white; border: none; border-radius: 4px; padding: 4px 10px; font-size: 12px; cursor: pointer;">åˆ é™¤</button>
                      </div>
                      <p><span style="font-weight: bold;">è€æ¿ï¼š</span>${o.bossName}</p>
                      <p><span style="font-weight: bold;">å•å­ç±»å‹ï¼š</span>${typeName}</p>
                      <p><span style="font-weight: bold;">é‡‘é¢ï¼š</span>Â¥${o.amount}</p>
                      ${o.divinerId && o.divinerId !== 'æ— ' ? `<p><span style="font-weight: bold;">å åœå¸ˆï¼š</span>${o.divinerId}</p>` : ''}
                      ${o.questionContent ? `<p><span style="font-weight: bold;">é—®é¢˜ï¼š</span>${o.questionContent}</p>` : ''}
                   </div>
                 `;
          }).join('')
        }
          </div>
        </div >
      `;
      document.getElementById('pageContent').innerHTML = html;
    }

    async function deleteReceptionistOrder(orderId, receptionistId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®¢å•å—ï¼Ÿ')) return;

      await DataStore.deleteOrder(orderId);
      await refreshData();
      renderReceptionistDetail({ id: receptionistId });
    }

    // å åœå¸ˆè¯¦ç»†è®°å½•è§†å›¾
    function renderDivinerDetail(data) {
      if (!data || !data.name) {
        setView('manageReceptionists');
        return;
      }

      const divinerName = data.name;
      const orders = cachedData.orders.filter(o => o.divinerId === divinerName);

      // æŒ‰æ—¶é—´å€’åº
      orders.sort((a, b) => new Date(b.date) - new Date(a.date));

      const receptionists = cachedData.receptionists;

      const totalIncome = orders.reduce((sum, o) => {
        if (o.type === 'monthly' || o.type === 'prepaid' || o.type === 'bonus') return sum;

        const amount = o.amount || 0;
        // æ‰£é™¤å­˜å•ï¼šå åœå¸ˆæ‹¿å…¨éƒ¨
        if (o.type === 'deduct_prepaid') {
          return sum + amount;
        }

        // æ­£å¸¸å•/ç¤¼ç‰©å•
        const rec = receptionists.find(r => r.id === o.receptionistId) || { commissionRate: 5 };
        const recComm = calculateCommission(o, rec);
        const stuComm = calculateStudioIncomeForOrder(o);
        const divComm = amount - recComm - stuComm;
        return sum + divComm;
      }, 0);

      let html = renderHeader() + `
      <div class="card" >
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 24px;">
             <button class="btn-text" onclick="setView('manageReceptionists')">â† è¿”å›</button>
             <h2 style="font-size: 18px; margin: 0;">ğŸ”® ${divinerName} çš„å åœè®°å½•</h2>
          </div>

           <div style="background: transparent; border: 1px solid var(--border); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
               <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                  <div>
                    <p class="text-muted">ç´¯è®¡å åœ</p>
                    <p style="font-size: 20px; font-weight: bold; color: var(--text);">${orders.length} å•</p>
                  </div>
                  <div>
                    <p class="text-muted">æ€»å…±æ”¶å…¥</p>
                    <p style="font-size: 20px; font-weight: bold; color: var(--accent);">Â¥${totalIncome.toFixed(2)}</p>
                  </div>
               </div>
           </div>
          
          <div style="display: flex; flex-direction: column; gap: 12px;">
            ${orders.length === 0 ? '<p class="text-muted text-center">æš‚æ— è®°å½•</p>' :
          orders.map(o => {
            const typeName = getOrderTypeName(o.type);
            const typeColor = getOrderTypeColor(o.type);
            const receptionists = cachedData.receptionists;
            const r = receptionists.find(rec => rec.id === o.receptionistId);
            const rName = r ? r.name : 'æœªçŸ¥';

            return `
                   <div style="background: var(--bg-light); padding: 12px; border-radius: 8px; border-left: 4px solid ${typeColor}; font-size: 14px; line-height: 1.6;">
                      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                        <p style="margin: 0;"><span style="font-weight: bold;">æ—¥æœŸï¼š</span>${formatDate(o.date)}</p>
                        <button onclick="deleteDivinerOrder(${o.id}, '${divinerName}')" style="background: var(--danger); color: white; border: none; border-radius: 4px; padding: 4px 10px; font-size: 12px; cursor: pointer;">åˆ é™¤</button>
                      </div>
                      <p><span style="font-weight: bold;">è€æ¿ï¼š</span>${o.bossName}</p>
                      <p><span style="font-weight: bold;">å•å­ç±»å‹ï¼š</span>${typeName}</p>
                      <p><span style="font-weight: bold;">é‡‘é¢ï¼š</span>Â¥${o.amount}</p>
                      <p><span style="font-weight: bold;">æ¥å¾…ï¼š</span>${rName}</p>
                      ${o.questionContent ? `<p><span style="font-weight: bold;">é—®é¢˜ï¼š</span>${o.questionContent}</p>` : ''}
                   </div>
                 `;
          }).join('')
        }
          </div>
        </div >
      `;
      document.getElementById('pageContent').innerHTML = html;
    }

    async function deleteDivinerOrder(orderId, divinerName) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®¢å•å—ï¼Ÿ')) return;

      await DataStore.deleteOrder(orderId);
      await refreshData();
      renderDivinerDetail({ name: divinerName });
    }

    // è€æ¿è¯¦ç»†è®°å½•è§†å›¾
    function renderBossDetail(data) {
      if (!data || !data.name) {
        setView('bossList');
        return;
      }

      const bossName = data.name;
      const orders = cachedData.orders.filter(o => o.bossName === bossName);

      // 1. Sort chronologically (Old -> New) to calculate running balance correctly
      orders.sort((a, b) => new Date(a.date) - new Date(b.date));

      let runningBalance = 0;

      // 2. Map orders to include balance snapshot
      let processedOrders = orders.map(o => {
        const price = o.amount || 0;
        if (o.type === 'prepaid') {
          runningBalance += price;
        } else if (o.type === 'deduct_prepaid') {
          runningBalance -= price;
        }
        return {
          ...o,
          snapshotBalance: runningBalance
        };
      });

      // 3. Filter out monthly cards (Hide them)
      processedOrders = processedOrders.filter(o => o.type !== 'monthly');

      // 4. Sort reverse chronologically (New -> Old) for display
      processedOrders.reverse();

      let html = renderHeader() + `
      <div class="card" >
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 24px;">
             <button class="btn-text" onclick="setView('bossList')">â† è¿”å›</button>
             <h2 style="font-size: 18px; margin: 0;">ğŸ¯ ${bossName} çš„æ¶ˆè´¹è®°å½•</h2>
          </div>
          
          <div style="display: flex; flex-direction: column; gap: 12px;">
            ${processedOrders.length === 0 ? '<p class="text-muted text-center">æš‚æ— è®°å½•</p>' :
          processedOrders.map(o => {
            const price = o.amount || 0;
            const typeName = getOrderTypeName(o.type);
            const typeColor = getOrderTypeColor(o.type);
            const r = cachedData.receptionists.find(x => x.id === o.receptionistId);
            const rName = r ? r.name : 'æœªçŸ¥';
            const balance = o.snapshotBalance.toFixed(0);

            return `
                   <div style="background: var(--bg-light); padding: 16px; border-radius: 12px; border-left: 4px solid ${typeColor}; position: relative;">
                      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                         <span style="font-weight: bold; font-size: 16px; color: ${typeColor};">${typeName}</span>
                         <div style="display: flex; align-items: center; gap: 8px;">
                           <span style="font-size: 14px; color: var(--text-muted);">${formatDate(o.date)}</span>
                           <button onclick="deleteBossOrder(${o.id}, '${bossName}')" style="background: var(--danger); color: white; border: none; border-radius: 4px; padding: 4px 10px; font-size: 12px; cursor: pointer;">åˆ é™¤</button>
                         </div>
                      </div>
                      
                      <div style="font-size: 14px; color: var(--text-muted); line-height: 1.6; margin-bottom: 8px;">
                        ${o.questionContent ? `<p>é—®é¢˜ï¼š<span style="color: var(--text);">${o.questionContent}</span></p>` : ''}
                        <p>å•å­ä»·æ ¼ï¼š<span style="color: ${typeColor}; font-weight: 600;">Â¥${price}</span></p>
                        <p>æ¥å¾…ï¼š<span style="color: var(--text);">${rName}</span></p>
                        ${o.divinerId && o.divinerId !== 'æ— ' ? `<p>å åœå¸ˆï¼š<span style="color: var(--text);">${o.divinerId}</span></p>` : ''}
                      </div>

                      <div style="text-align: right; border-top: 1px dashed var(--border); padding-top: 12px; margin-top: 8px;">
                         <span style="color: var(--text-muted); font-size: 12px;">å½“å‰ä½™é¢ï¼š</span>
                         <span style="font-size: 24px; font-weight: bold; color: ${typeColor};">Â¥${balance}</span>
                      </div>
                   </div>
                 `;
          }).join('')
        }
          </div>
        </div >
      `;

      document.getElementById('pageContent').innerHTML = html;
    }

    async function deleteBossOrder(orderId, bossName) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®¢å•å—ï¼Ÿ')) return;

      await DataStore.deleteOrder(orderId);
      await refreshData();
      renderBossDetail({ name: bossName });
    }

  </script>
</body>

</html>